---
title: "Assessing small pelagic fish trends in space<br /> and time using piscivore diet data"
subtitle: "Small Pelagic Fish Symposium Session 5,<br /> 10 November 2022"
author: "Sarah Gaichas, James Gartland, Brian Smith, Elizabeth Ng, Michael Celestino, <br /> Anthony Wood, Katie Drew, Abigail Tyrell, and James Thorson"
institute: 
output:
  xaringan::moon_reader:
    css: ["default", "libs/EDAB_theme3_508_SOE_16by9.css"]
    lib_dir: libs
    nature:
      titleSlideClass: ["right", "middle", "my-title"]
      ratio: "16:9"
      highlightStyle: githubp
      highlightLines: true
      countIncrementalSlides: false
      beforeInit: "libs/macros.js"
  revealjs::revealjs_presentation:
    self_contained: false
    reveal_plugins: ["notes", "search"]
---
class: top, left

```{r setup, include=FALSE}

options(htmltools.dir.version = FALSE)
knitr::opts_chunk$set(echo = F,
                      fig.retina = 3,
                      warning = F,
                      message = F,
                      error = F)
knitr::knit_hooks$set(crop = knitr::hook_pdfcrop)
#Plotting and data libraries
library(tidyverse)
library(tidyr)
library(here)
```

```{r, load_refs, include=FALSE, cache=FALSE}
#trick to downlaod bib file from other repo to keep just 1 up to date

url <- "https://raw.githubusercontent.com/sgaichas/bluefishdiet/main/FishDiet_EcoIndicators.bib"
  download.file(url, destfile = "./FishDiet_Ecoindicators.bib")

library(RefManageR)
BibOptions(check.entries = FALSE,
           bib.style = "authoryear",
           cite.style = "authoryear",
           longnamesfirst = FALSE,
           max.names = 1,
           style = "markdown")
myBib <- ReadBib("./FishDiet_Ecoindicators.bib", check = FALSE)

#,
#           hyperlink = FALSE,
#           dashed = FALSE

```

# Does prey drive availability of bluefish?

## Bluefish, *Pomatomus saltatrix*

.pull-left[
![Bluefish illustration, credit NOAA Fisheries](https://media.fisheries.noaa.gov/styles/original/s3/2022-08/640x427-Bluefish-NOAAFisheries.png)
]

.pull-right[
.large[

"... it is perhaps the most ferocious and bloodthirsty fish in the sea, leaving in its wake a trail of dead and mangled mackerel, menhaden, herring, alewives, and other species on which it preys." `r Cite(myBib, "collette_bigelow_2002")`

"From Raritan Bay to Rockaway Inlet, we have had a phenomenal bluefish year with lots of bunker and other bait, ultimately leading to an abundance of bluefish." [Mid-Atlantic Bluefish Fishery Performance Report, 2021](https://www.mafmc.org/s/8_BF-FPR-2021.pdf)

]
]

.center[
Can localized predator prey observations scale to coastwide assessment and management? 
]

???
1 NOAA NMFS Northeast Fisheries Science Center, Woods Hole, MA, USA. 
2 Virginia Institute of Marine Science, Gloucester Point, VA, USA
3 University of Washington, Seattle, WA, USA
4 New Jersey Department of Environmental Protection, Port Republic, NJ, USA
5 Atlantic States Marine Fisheries Commission, Arlington, VA, USA
6 Ocean Associates Inc, Arlington, VA, USA

Changing distribution and abundance of small pelagics may drive changes in predator distributions, affecting predator availability to fisheries and surveys. However, small pelagic fish are difficult to survey directly, so we developed a novel method of assessing small pelagic fish aggregate abundance via predator diet data. We used piscivore diet data collected from multiple bottom trawl surveys within a Vector Autoregressive Spatio-Temporal (VAST) model to assess trends of small pelagics on the Northeast US shelf. The goal was to develop a spatial “forage index” to inform survey and/or fishery availability in the bluefish (Pomatomus saltatrix) stock assessment. Using spring and fall surveys from 1973-2020, 20 small pelagic groups were identified as major bluefish prey using the diet data. Then, predators were grouped by diet similarity to identify 19 piscivore species with the most similar diet to bluefish in the region. Diets from all 20 piscivores were combined for the 20 prey groups at each surveyed location, and the total weight of small pelagic prey per predator stomach at each location was input into a Poisson-link delta model to estimate expected prey mass per predator stomach. Best fit models included spatial and spatio-temporal random effects, with predator mean length, number of predator species, and sea surface temperature as catchability covariates. Spring and fall prey indices were split into inshore and offshore areas to reflect changing prey availability over time in areas available to the recreational fishery and the bottom trawl survey, and also to contribute to regional ecosystem reporting

---
## Bluefish diet in the Northeast US: a mix of managed and unmanaged small pelagics 

.pull-left[
```{r, crop=TRUE, fig.show='hold', out.width="50%"}

knitr::include_graphics("https://media.fisheries.noaa.gov/styles/original/s3/2022-08/640x427-Squid-Longfin-v1-NOAAFisheries.png")
#credit: NOAA fisheries

knitr::include_graphics("https://objects.liquidweb.services/images/201909/robert_aguilar,_serc_48650727166_3ce8edc47d_b.jpg")
#credit: Robert Aguilar, Smithsonian Environmental Research Center

knitr::include_graphics("https://media.fisheries.noaa.gov/styles/original/s3/2022-08/640x427-Butterfish-NOAAFisheries.png")
#credit: NOAA fisheries

knitr::include_graphics("https://media.fisheries.noaa.gov/styles/original/s3/2022-09/640x427-Scup-NOAAFisheries_0.png")
#credit: NOAA fisheries

knitr::include_graphics("https://media.fisheries.noaa.gov/styles/original/s3/2022-08/640x427-Herring-Atlantic-NOAAFisheries.png")
#credit: NOAA fisheries

knitr::include_graphics("https://media.fisheries.noaa.gov/styles/original/s3/2022-08/640x427-Mackerel-Atlantic-NOAAFisheries.png")
#credit: NOAA fisheries

```

]

.pull-right[

```{r, crop=TRUE, fig.show='hold', out.width="50%"}

knitr::include_graphics("https://diveary.com/img/species/cache/323__jpg.jpeg") 
#credit:  https://diveary.com/species/show/id/323/name/red-eye+round+herring

knitr::include_graphics("https://www.vims.edu/research/departments/fisheries/programs/juvenile_surveys/netnotes_listing/_photosets/0910_dec_jan/_northernsandlance.jpg")
#credit: VIMS, https://www.vims.edu/research/departments/fisheries/programs/juvenile_surveys/netnotes_listing/0910_dec_jan.php

knitr::include_graphics("https://media.fisheries.noaa.gov/styles/original/s3/2022-09/640x427-Hake-Silver-NOAAFisheries.png")
#credit: NOAA fisheries

knitr::include_graphics("https://media.fisheries.noaa.gov/styles/original/s3/2021-03/squid_illex_nb_w_0.png")
#credit: NOAA fisheries

knitr::include_graphics("https://media.fisheries.noaa.gov/styles/original/s3/2021-01/640x427-Atlantic_Menhaden_NB_W.jpg")
#credit: NOAA fisheries


```

[Northeast Fisheries Science Center Diet Data Online](https://fwdp.shinyapps.io/tm2020/)
] 

???
squid, anchovies, butterfish, herrings, sand lances, scup, silver hake, atlantic mackerel, atlantic menhaden. and bluefish. and flounders. 

---
## Bottom trawl survey small pelagics abundance estimates ([Northeast US Ecosystem Reports](https://www.fisheries.noaa.gov/new-england-mid-atlantic/ecosystems/state-ecosystem-reports-northeast-us-shelf))

```{r, fig.asp=0.55, out.width="95%", results='hide'}

# code modified from Kim Bastille's ecodata macrofauna_MAB.Rmd

#Time series constants
shade.alpha <- 0.3
shade.fill <- "lightgrey"
lwd <- 1
pcex <- 2
trend.alpha <- 0.5
trend.size <- 2
hline.size <- 1
hline.alpha <- 0.35
hline.lty <- "dashed"
label.size <- 5
hjust.label <- 1.5
letter_size <- 4
feeding.guilds <- c("Apex Predator","Piscivore","Planktivore","Benthivore","Benthos")
x.shade.min <- 2011
x.shade.max <- 2021
series.col <- c("indianred","black")
#Function for custom ggplot facet labels
label <- function(variable,value){
  return(facet_names[value])
}

planktivores <- ecodata::aggregate_biomass %>%
  dplyr::filter(Var %in% c("Planktivore Fall Biomass Index",
                           "Planktivore Spring Biomass Index",
                           "Planktivore Fall Biomass Standard Error",
                           "Planktivore Spring Biomass Standard Error"))%>%
  tidyr::separate(Var, c("feeding.guild", "season", "Biomass", "Var1", "Null", "Area"), sep = " ") %>%
  tidyr::unite("Var", feeding.guild:season, sep = " ") %>%
  dplyr::mutate(stat = recode(Var1, Index = "Mean",
                      Standard = "SD")) %>%
  dplyr::select(-Biomass, -Var1, -Null, -Units) %>%
  # dplyr::filter(!Area == "-") %>%
  dplyr::group_by(Var, Time, EPU, Area) %>%
  tidyr::pivot_wider(id_cols = c(Var, Time, EPU, Area),names_from =  stat, values_from =  Value) %>%
  dplyr::filter(!Mean == "NULL") %>%
  dplyr::ungroup() %>%
  dplyr::mutate(Mean = as.numeric(Mean))


agg_bio<-planktivores %>% dplyr::filter(EPU %in% c("MAB", "GB"),
         Time >= 1968) %>%
  dplyr::group_by(Var, EPU) %>%
  dplyr::mutate(hline = mean(Mean, na.rm = T), 
                 upper = Mean + (2*SD),
                lower = Mean - (2*SD)) %>%
  dplyr::ungroup()  
 

agg_bio$Var <- factor(agg_bio$Var,levels = c("Planktivore Spring",
                                                    "Planktivore Fall"))
series.col <- rep("black",length(unique(agg_bio$Var)))
facet_names <- list("Planktivores" = expression("Planktivores")
                    )
#Get NEAMAP
neamap <- ecodata::mab_inshore_survey %>%
  tidyr::separate(Var, into = c("Var",  "Val"), sep = "-") %>% 
  tidyr::pivot_wider(names_from = Val, values_from = Value) %>% 
  dplyr::mutate(Value = as.numeric(Value), 
                CV = as.numeric(CV)) %>% 
  dplyr::group_by(Var) %>%
  dplyr::mutate(hline = mean(Value),
         SD = Value * CV, #calculate SD from CV
         upper = Value + (2*SD),
         lower = Value - (2*SD))

neamap$Var <- factor(neamap$Var,levels = c("Piscivore Spring","Piscivore Fall",
                                           "Benthivore Spring", "Benthivore Fall",
                                           "Planktivore Spring", "Planktivore Fall",
                                           "Benthos Spring", "Benthos Fall"))

### Planktivore
neamap.3<-neamap %>%
  dplyr::filter(str_detect(Var,"Planktivore"))
p3<-agg_bio %>%
  dplyr::filter(str_detect(Var,"Planktivore")) %>%
  ggplot2::ggplot() +

  #Highlight last ten years
  ggplot2::annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max ,
      ymin = -Inf, ymax = Inf) +
  #Test for trend and add lines
  ecodata::geom_gls(aes(x = Time, y = Mean,
               color = Var),
             alpha = trend.alpha, size = trend.size) +
  ecodata::geom_lm(aes(x = Time, y = Mean,
               color = Var),
             alpha = trend.alpha, size = trend.size) +
  #ecodata::geom_lm(aes(x = Time, y = Mean))+

  #Add time series
  ggplot2::geom_ribbon(aes(x = Time, ymin = pmax(lower,0), ymax = upper),
              alpha = 0.5,
              fill = "grey") +
  ggplot2::geom_line(aes(x = Time, y = Mean),size = lwd-0.5) +
  ggplot2::geom_point(aes(x = Time, y = Mean),size = pcex-0.5) +
  ggplot2::scale_color_manual(values = series.col, aesthetics = "color")+
  ggplot2::guides(color = FALSE) +
  ggplot2::geom_hline(aes(yintercept = hline,
                 group = Var),
             size = hline.size,
             alpha = hline.alpha,
             linetype = hline.lty)+
  ggplot2::facet_wrap(EPU ~ Var~.,ncol = 2, scales = "free_y") +
       #Add NEAMAP
  ggplot2::geom_ribbon(data = neamap.3, aes(ymax = pmax(upper, 0), ymin = lower, x = Time),
                fill = "pink", alpha = 0.5) +
  ggplot2::geom_line(data = neamap.3, aes(x = Time, y = Value),
            color = "#ca0020")+
  ggplot2::geom_point(data = neamap.3, aes(x = Time, y = Value),
             size = pcex-0.5,
             color = "#ca0020")+

  #Axis and theme
  ggplot2::scale_x_continuous(breaks = seq(1970, 2020, by = 10), expand = c(0.01, 0.01)) +
  #ylim(0, 600)+
  ggplot2::ylab(expression("Biomass (kg tow"^-1*")")) +
  ecodata::theme_facet()+
  ggplot2::theme(strip.text=element_text(hjust=0),
        axis.title.x=element_blank())

p3

```

???

Bottom trawls are not designed for efficient sampling of small pelagics. While we can estimate aggregate planktivore biomass for different ecoregions on the Northeast US shelf, estimates have high observation error. Black lines = NEFSC bottom trawl, Red lines = NEAMAP inshore bottom trawl

---
background-image: url("https://github.com/NOAA-EDAB/presentations/raw/master/docs/EDAB_images/Ng2022dietvsassess.png"), url("https://github.com/NOAA-EDAB/presentations/raw/master/docs/EDAB_images/NgPredStomForageB2022.png")
background-size: 800px, 400px
background-position: right, left

## Fish stomach contents &rarr; Atlantic herring biomass estimates `r Cite(myBib, "ng_predator_2021")`

<!--.pull-left-40[
![:img Ng paper title](https://github.com/NOAA-EDAB/presentations/raw/master/docs/EDAB_images/NgPredStomForageB2022.png)
]

.pull-right-60[]-->
???

---
## VAST modeling `r Cite(myBib, c("thorson_comparing_2017", "thorson_guidance_2019"))`


---
## Bluefish stomachs only?

![Fall bluefish NEFSC](pyindextests/nefsc_data/allagg_fallbluefish/Data_by_year.png)

---
## Aggregating predators: diet similarity to bluefish

.pull-left[
```{r, fig.asp=1}
dietoverlap <- read_csv("https://raw.githubusercontent.com/sgaichas/bluefishdiet/main/datfromshiny/tgmat.2022-02-15.csv")

library(dendextend)

d_dietoverlap <- dist(dietoverlap)

guilds <- hclust(d_dietoverlap)

#plot(guilds)

dend <- as.dendrogram(guilds)

dend <- rotate(dend, 1:136)

dend <- color_branches(dend, k=6)

dend <- color_labels(dend, k=6)

labels(dend) <- paste(as.character(names(dietoverlap[-1]))[order.dendrogram(dend)],
                           "(",labels(dend),")", 
                           sep = "")

dend <- hang.dendrogram(dend,hang_height=0.1)

# reduce the size of the labels:
# dend <- assign_values_to_leaves_nodePar(dend, 0.5, "lab.cex")
dend <- set(dend, "labels_cex", 0.75)
# And plot:
# par(mar = c(3,3,3,7))
# plot(dend, 
#      main = "Clustered NEFSC diet data, (complete)
#      (the labels give the predator species/size)", 
#      horiz =  TRUE,  nodePar = list(cex = .007))

circlize::circos.par(start.degree = 90)
par(mar = rep(0,4))
circlize_dendrogram(dend,
                    labels_track_height=0.3,
                    dend_track_height = 0.6)
```
]

.pull-right[
```{r, crop=TRUE, fig.show='hold', out.width="25%"}

knitr::include_graphics("https://media.fisheries.noaa.gov/styles/original/s3/2022-08/640x427-Bluefish-NOAAFisheries.png")

knitr::include_graphics("https://media.fisheries.noaa.gov/styles/original/s3/2022-07/640x427-Cod-Atlantic-NOAAFisheries.png?itok=kNKcZ7iV")

knitr::include_graphics("https://media.fisheries.noaa.gov/styles/original/s3/2022-08/640x427-Shark-SpinyDogfish-NOAAFisheries.png?itok=cdjTG3Hz")

knitr::include_graphics("https://media.fisheries.noaa.gov/styles/original/s3/2022-09/640x427-Monkfish-NOAAFisheries.png?itok=7JAgAz-u")

knitr::include_graphics("https://media.fisheries.noaa.gov/styles/original/s3/2022-09/640x427-Flounder-Summer-NOAAFisheries.png?itok=II2ii-Qw")

knitr::include_graphics("https://media.fisheries.noaa.gov/styles/original/s3/2022-08/640x427-Pollock-Atlantic-NOAAFisheries.png?itok=ZFoDB-Qr")

knitr::include_graphics("https://media.fisheries.noaa.gov/styles/original/s3/2022-09/640x427-Hake-Red-NOAAFisheries.png?itok=SyCYEmmm")

knitr::include_graphics("https://media.fisheries.noaa.gov/styles/original/s3/2022-08/640x427-Halibut-Atlantic-right-NOAAFisheries.png?itok=uPvRdIBx")

knitr::include_graphics("https://media.fisheries.noaa.gov/styles/original/s3/2022-08/640x427-StripedBass-NOAAFisheries.png?itok=4ZQoQM0S")

knitr::include_graphics("https://media.fisheries.noaa.gov/styles/original/s3/2020-12/640x427-Hake_White_NB_W.jpg?itok=yHy_AuTT")

knitr::include_graphics("https://media.fisheries.noaa.gov/styles/original/s3/2022-09/640x427-Hake-Silver-NOAAFisheries.png")

knitr::include_graphics("https://media.fisheries.noaa.gov/styles/original/s3/dam-migration/640x427-cusk.jpg?itok=u0fw0hiv")

```

```{r, eval=FALSE}


knitr::include_graphics("")

knitr::include_graphics("")

knitr::include_graphics("")

knitr::include_graphics("")

knitr::include_graphics("")

knitr::include_graphics("")

knitr::include_graphics("")
  
  

```

]



---
## "Catchability" covariates for aggregate predator samplers at a location

Number of predator species &rarr; likely to affect *encounter rate*

Mean size of predators &rarr; likely to affect *amount of prey* 

Sea surface temperature &rarr; likely to affect predator feeding rate *encounter rate and amount of prey*

(SST is also likely to affect prey distribution, but differently for each prey species. Therefore, SST not modeled as a density covariate for aggregate small pelagics.)

Model selection consistently included number of predator species, mean predator size, and SST as covariates using fall, spring, and annual datasets

---
## Spatial partitioning: examining small pelagics at multiple scales

---
## Results


---
## P.S., Did it help the assessment?


---
## References

```{r refs, echo=FALSE, results="asis"}
PrintBibliography(myBib)
```

## Additional resources

[Northeast US State of the Ecosystem Reports](https://www.fisheries.noaa.gov/new-england-mid-atlantic/ecosystems/state-ecosystem-reports-northeast-us-shelf)


.footnote[
Slides available at https://noaa-edab.github.io/presentations  
Contact: <Sarah.Gaichas@noaa.gov>
]
