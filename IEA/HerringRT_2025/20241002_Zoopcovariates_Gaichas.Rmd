---
title: "Zooplankton indices as covariates in WHAM"
subtitle: "Herring Research Track <br /> 2 October 2024"
author: Sarah Gaichas$^1$, Jon Deroba$^1$, Adelle Molina$^{1,2} 
institute: <span style="font-weight:normal;"><font size="-0.5">$^1$NOAA NMFS Northeast Fisheries Science Center, Woods Hole, MA, USA; $^2$Ocean Associates Inc, Arlington, VA, USA;</font></span>
output:
  xaringan::moon_reader:
    css: ["default", "libs/EDAB_theme3_508_SOE_16by9.css"]
    lib_dir: libs
    nature:
      titleSlideClass: ["right", "middle", "my-title"]
      ratio: "16:9"
      highlightStyle: githubp
      highlightLines: true
      countIncrementalSlides: false
      beforeInit: "libs/macros.js"
  revealjs::revealjs_presentation:
    self_contained: false
    reveal_plugins: ["notes", "search"]
---
class: top, left

```{r setup, include=FALSE}

options(htmltools.dir.version = FALSE)
knitr::opts_chunk$set(echo = F,
                      fig.retina = 3,
                      warning = F,
                      message = F,
                      error = F)
knitr::knit_hooks$set(crop = knitr::hook_pdfcrop)
#Plotting and data libraries
library(tidyverse)
theme_set(theme_bw())
library(tidyr)
library(here)
library(sf)
library(patchwork)
library(ggpubr)
library(data.table)
library(forcats)
```

```{r, load_refs, include=FALSE, cache=FALSE}
#trick to downlaod bib file from other repo to keep just 1 up to date

# url <- "https://raw.githubusercontent.com/sgaichas/bluefishdiet/main/FishDiet_EcoIndicators.bib"
#   download.file(url, destfile = "./FishDiet_Ecoindicators.bib")

library(RefManageR)
BibOptions(check.entries = FALSE,
           bib.style = "authoryear",
           cite.style = "authoryear",
           longnamesfirst = FALSE,
           max.names = 1,
           style = "markdown")
myBib <- ReadBib("./FishDiet_Ecoindicators.bib", check = FALSE)

#,
#           hyperlink = FALSE,
#           dashed = FALSE

```
# Does food drive recruitment of Atlantic herring?

## Atlantic herring, *Clupea harengus*

.pull-left[
![Atlantic herring illustration, credit NOAA Fisheries](https://www.fisheries.noaa.gov/s3/styles/original/s3/2022-08/640x427-Herring-Atlantic-NOAAFisheries.png)
]

.pull-right[
.large[

"The herring is a plankton feeder.... Examination of 1 ,500 stomachs showed that adult herring near Eastport were living solely on copepods and on pelagic euphausiid shrimps (*Meganyctiphanes norwegica*), fish less than 4 inches long depending on the former alone, while the larger herring were eating both." `r Cite(myBib, "collette_bigelow_2002")`

]
]

???
When first hatched, and before the disappearance of the yolk sac, the larvae (European) feed on larval snails and crustaceans, on diatoms, and on peridinians, but they soon begin taking copepods, and depend exclusively on these for a time after they get to be 12 mm. long, especially on the little Pseudocalanus elongatus. As they grow older they feed more and more on the larger copepods and amphipods, pelagic shrimps, and decapod crustacean larvae.


---
## Outline

.pull-left-60[

1. Covariate selection

1. Stock assessment application

1. Discussion

]

.pull-right-40[
![xkcd maps](https://imgs.xkcd.com/comics/heatmap.png)
.contrib[
https://xkcd.com/1138
]
]

---
## Covariate selection

Which zooplankton index is likely to affect recruitment and why?

.pull-left[

herring conceptual model

]

.pull-right[

Adelle's boosted regression tree results

]




---
## Spatial partitioning: examining small pelagics trends at multiple scales

```{r}

# 3nm buffer
coast3nmbuff <- readRDS(url("https://github.com/sgaichas/bluefishdiet/raw/main/spatialdat/neus_coast3nmbuff.rds"))

fedwaters <- setdiff(FishStatsUtils::northwest_atlantic_grid, coast3nmbuff)


#current bluefish assessment strata are all Bigelow inshore strata MAB-GB
bfinshore <- c(3020, 3050, 3080, 3110, 3140, 3170, 3200, 3230, 
              3260, 3290, 3320, 3350, 3380, 3410, 3440, 3450, 3460)

bfinshoregrid <-  FishStatsUtils::northwest_atlantic_grid %>%
  filter(stratum_number %in% bfinshore)
  
  
# from Tony's 8 March presentation, minus the inshore in CCBay
bfoffshore <- c(1010, 1730, 1690, 1650, 1050, 1060, 1090, 1100, 1250, 1200, 1190, 1610)

bfoffshoregrid <-  FishStatsUtils::northwest_atlantic_grid %>%
  filter(stratum_number %in% bfoffshore)

#from mskeyrun vignette, EPU based on survey strata, replace built in VAST EPU
#https://noaa-edab.github.io/ms-keyrun/articles/GBSurveySet.html

MAB <- c(1010:1080, 1100:1120, 1600:1750, 3010:3450, 3470, 3500, 3510)
GB  <- c(1090, 1130:1210, 1230, 1250, 3460, 3480, 3490, 3520:3550)
GOM <- c(1220, 1240, 1260:1290, 1360:1400, 3560:3830)

MABgrid <-  FishStatsUtils::northwest_atlantic_grid %>%
  filter(stratum_number %in% c(MAB))

GBgrid <-  FishStatsUtils::northwest_atlantic_grid %>%
  filter(stratum_number %in% c(GB))

GOMgrid <-  FishStatsUtils::northwest_atlantic_grid %>%
  filter(stratum_number %in% c(GOM))

MABGBgrid <-  FishStatsUtils::northwest_atlantic_grid %>%
  filter(stratum_number %in% c(MAB, GB))

albinshoregrid <- MABGBgrid %>%
  filter(stratum_number>2999 & stratum_number<3999) %>% #inshore
  anti_join(bfinshoregrid)

othoffshoregrid <- MABGBgrid %>%
  anti_join(bind_rows(albinshoregrid, bfinshoregrid, bfoffshoregrid))

statewatersgrid <- coast3nmbuff %>%
  inner_join(MABGBgrid)

fedwatersgrid <- fedwaters %>%
  inner_join(MABGBgrid)

allinshoregrid <- MABGBgrid %>%
  filter(stratum_number>2999 & stratum_number<3999) #combines albatross and bigelow inshore

```

```{r maps, crop=TRUE, fig.cap="Maps of key areas for Bluefish assessment indices. The full VAST model grid is shown in brown.", fig.show='hold', out.width="33%"}

theme_set(theme_bw())

ggplot(data = ecodata::coast) +
  geom_sf() + 
  geom_point(data = FishStatsUtils::northwest_atlantic_grid, aes(x = Lon, y = Lat),  colour = "coral4", size=0.05, alpha=0.1) +
  geom_point(data = MABgrid, aes(x = Lon, y = Lat), colour = "green3", size=0.05, alpha=0.5) +
  geom_point(data = GBgrid, aes(x = Lon, y = Lat), colour = "orange", size=0.05, alpha=0.5) +
  geom_point(data = GOMgrid, aes(x = Lon, y = Lat), colour = "red", size=0.05, alpha=0.5) +
  #coord_sf(xlim = c(-79, -65.5), ylim = c(33, 45)) + #full extent of VAST model
  coord_sf(xlim =c(-78, -65.5), ylim = c(35, 45)) + #zoomed to Hatteras and N
  ggtitle("MAB (green), GB (orange), GOM (red)")


ggplot(data = ecodata::coast) +
  geom_sf() + 
  geom_point(data = FishStatsUtils::northwest_atlantic_grid, aes(x = Lon, y = Lat),  colour = "coral4", size=0.05, alpha=0.1) +
  geom_point(data = MABGBgrid, aes(x = Lon, y = Lat), size=0.05, colour = "yellow",  alpha=0.1) +
  geom_point(data = albinshoregrid, aes(x = Lon, y = Lat), size=0.03, colour = "lightblue",  alpha=0.3) +
  geom_point(data = bfinshoregrid, aes(x = Lon, y = Lat), size=0.05, colour = "blue") +
  geom_point(data = bfoffshoregrid, aes(x = Lon, y = Lat), size=0.05, colour = "lightblue1",  alpha=0.3) +
  #coord_sf(xlim = c(-79, -65.5), ylim = c(33, 45)) +
  coord_sf(xlim =c(-78, -65.5), ylim = c(35, 45)) +
  ggtitle("Inshore (light and dark blue) and offshore (light blue) bluefish survey strata")

ggplot(data = ecodata::coast) +
  geom_sf() + 
  geom_point(data = FishStatsUtils::northwest_atlantic_grid, aes(x = Lon, y = Lat),  colour = "coral4", size=0.05, alpha=0.1) +
  geom_point(data = MABGBgrid, aes(x = Lon, y = Lat), size=0.05, colour = "yellow",  alpha=0.1) +
  geom_point(data = statewatersgrid, aes(x = Lon, y = Lat), size=0.03, colour = "purple",  alpha=0.5) +
  #coord_sf(xlim = c(-79, -65.5), ylim = c(33, 45)) +
  coord_sf(xlim =c(-78, -65.5), ylim = c(35, 45)) +
  ggtitle("State waters (purple), concentrated bluefish recreational fishing")

```

Indices for aggregate small pelagics from piscivore stomachs can be calculated for any subset of the full model domain. Bias correction of the resulting indices is then applied `r Cite(myBib, "thorson_implementing_2016")`. 

???
NEFSC survey strata definitions are built into the VAST `northwest-atlantic` extrapolation grid already. We defined additional new strata to address the recreational inshore-offshore 3 mile boundary. The area within and outside 3 miles of shore was defined using the `sf` R package as a 3 nautical mile (approximated as 5.556 km) buffer from a high resolution coastline from the`rnaturalearth` R package. This buffer was then intersected with the current `FishStatsUtils::northwest_atlantic_grid` built into VAST and saved using code [here](https://github.com/sgaichas/bluefishdiet/blob/main/VASTcovariates_updatedPreds_sst_3mi.Rmd#L49-L94). Then, the new State and Federal waters strata were used to split NEFSC survey strata where applicable, and the new full set of strata were used along with a modified function from `FishStatsUtils::Prepare_NWA_Extrapolation_Data_Fn` to build a custom extrapolation grid for VAST as described in detail [here](https://sgaichas.github.io/bluefishdiet/VASTcovariates_finalmodbiascorrect_3misurvstrat.html). 


---
## Integrating into stock assessment 

.pull-left[
A new herring stock assessment was implemented using the Woods Hole Assessment Model (WHAM) `r Cite(myBib,"stock_woods_2021")`.

WHAM is a state space stock assessment model framework: https://timjmiller.github.io/wham/

Zooplankton indices were explored as covariates on herring recruitment.

We explored indices with different zooplankton groups, seasons, and regions according to herring life history and results from the boosted regression tree:

*  Jan-Jun large copepods  in spring herring BTS strata with lag-0 to represent food for pre-recruit juveniles
*  Jul-Dec small copepods in fall herring BTS strata with lag-1 to represent food for larvae in general
*  Sep-Feb small copepods in herring larval area with lag-1 to represent food for larvae more specifically

]

.pull-right[
```{r results='hide', message=FALSE}

u1 <- "https://github.com/NOAA-EDAB/forageindex/raw/main/WHAMoutput/BF28C_m7_ecov_off.rds"
u2 <- "https://github.com/NOAA-EDAB/forageindex/raw/main/WHAMoutput/BF28C_m7_ecov_on.rds"
  
ecov_off <- readRDS(url(u1, method="libcurl"))
ecov_on <- readRDS(url(u2, method="libcurl"))

mods <- list(ecov_off, ecov_on)
names(mods) <- c("ecov_off", "ecov_on")

compwham <- wham::compare_wham_models(mods, do.plot = F, fdir = here::here("data"))

```


```{r WHAMq, fig.asp = 0.8, fig.cap="Fall state waters forage index fit as a catchabilty covariate within the bluefish assessment model (top), with resulting catchability, q, for the recreational fishery catch per unit effort (MRIP) index (bottom)."}

StateWaters <- splitoutnew |>
  dplyr::left_join(stratlook) %>%
  dplyr::filter(Region %in% c("GOM", "GB", "MAB","MABGBstate", "bfin")) %>%
  dplyr::mutate(Type = ifelse(Region %in% c("GOM", "GB", "MAB"), "Ecoregion", "Bluefish"),
                Region = case_when(Region == "MABGBstate" ~ "StateWaters",
                                   Region == "bfin" ~ "SurveyBluefish",
                                   TRUE ~ Region)) |>
  dplyr::filter(Region == "StateWaters") |>
  dplyr::mutate(logStateW = log(Estimate)) |>
  dplyr::select(year = Time, logStateW, SE = Std..Error.for.ln.Estimate.)

forageobs <- ecov_on$input$data$Ecov_obs
forageest <- ecov_on$rep$Ecov_out[,,1][,3]
forageestse <- ecov_on$rep$Ecov_obs_sigma

StateWatersWHAM <- StateWaters |>
  bind_cols(forageobs=forageobs, 
            forageest=forageest, 
            forageestse=forageestse)

foragefit <- ggplot(StateWatersWHAM, aes(x=year, y=forageobs, color="ln_StateWaters")) + #y=logStateW
  geom_point() +
  geom_ribbon(aes(ymin=forageobs-(1.96*SE), ymax=forageobs+(1.96*SE), fill="ln_StateWaters"),  linetype = 0, alpha = 0.15) +
  geom_line(aes(x=year, y=forageest, color="WHAM_fit"))+
  geom_ribbon(aes(ymin=forageest-(forageestse), ymax=forageest+(forageestse), 
                  fill="WHAM_fit"),  linetype = 0, alpha = 0.15) +
  scale_color_manual(name='Forage Index',
                     breaks=c('WHAM_fit', 'ln_StateWaters'),
                     values=c('ln_StateWaters'='purple', 'WHAM_fit'="indianred"),
                     aesthetics = c("colour", "fill")) +
  xlab("Year") +
  ylab("ln(State Waters fall forage)")


forageqMRIP <- ecov_on$rep$q[,3]
noqMRIP <- ecov_off$rep$q[,3]
assyear <- 1985:2021

se <- summary(ecov_on$sdrep)
se <- matrix(se[rownames(se) == "logit_q_mat",2], length(ecov_on$years))
forageqMRIPse <- se[,3]

WHAMq <- data.frame(year=assyear, ecovq=forageqMRIP, se=forageqMRIPse, qbase=noqMRIP)

WHAMfit <- ggplot(WHAMq, aes(x=year, y=ecovq, color='ecov_on'))+
  geom_line()+ #color="indianred"
  geom_ribbon(aes(ymin=ecovq*exp(-1.96*se), ymax=ecovq*exp(1.96*se), fill='ecov_on'),  linetype = 0, alpha = 0.15)+ 
  geom_line(aes(x=year, y=qbase, color='ecov_off')) +
  scale_color_manual(name='MRIP Catchability',
                     breaks=c('ecov_off', 'ecov_on'),
                     values=c('ecov_on'='indianred', 'ecov_off'="black"),
                     aesthetics = c("colour", "fill")) +
  xlab("Year") +
  ylab("Estimated catchability, q")

foragefit + WHAMfit + plot_layout(ncol = 1)

```

]
???


The Bigelow index fit with the fall forage fish index did not improve the model fit (AIC), was slightly worse fit and gave identical results
The Albatross index fit with the fall forage fish index did not converge or hessian was not positive definite for any of the models (even when how = 0 for some of them).
The MRIP index fit with the annual forage fish index did not converge or hessian was not positive definite for any of the models

---
.pull-left[
## Do prey affect bluefish availability? Yes, for the recreational CPUE index


```{r WHAMresults, ft.arraystretch = 1}

compwhamtab <- as.data.frame(compwham$tab) |>
  tibble::rownames_to_column(var = "model")

flextable::flextable(compwhamtab) |>
  flextable::set_caption("Bluefish stock assessment model fit and retrospective diagnostics with (model = ecov_on) and without (model = ecov_off) the fall StateWaters forage index included as a catchability covariate on the recreational fishery catch per unit effort index. Mohn's rho values (rho) indicate retrospective performance for recruitment (R), spawning stock biomass (SSB) and fully selected fishing mortality (Fbar).")

```
]

.pull-right[
*Inclusion of the forage fish index improved model fit.* 

```{r, fig.asp=1}


plotwham <- wham::compare_wham_models(mods, do.table = F, plot.opts=list(kobe.prob=FALSE,
                                                                         which=1),
                                      fdir=here::here("data"))

plotwham$g[[1]] + 
  scale_color_manual(values = c("black", "indianred")) + 
  scale_fill_manual(values = c("black", "indianred")) +
  theme(legend.position = "right")

```

]

The recreational index is important in scaling the biomass results, and the lower availability at the end of the time-series led to <span style="color:#cd5c5c;">higher biomass estimates from the assessment including forage fish.</span>  

---
## Including ecosystem information for fish stocks: Alaska Ecosystem and Socioeconomic Profiles

.pull-left[

![GOA pcod ESP conceptual model](https://media.fisheries.noaa.gov/styles/media_750_x500/s3/2022-03/Working_Conceptual_Model_EBS%20Pcod.png)  
&nbsp; 

Ecosystem and Socioeconomic Profiles (ESPs) `r Cite(myBib, c("shotwell_synthesizing_2022", "haltuch_oceanographic_2020", "tolimieri_oceanographic_2018", "dorn_risk_2020"))`
]

.pull-right[
![](https://github.com/NOAA-EDAB/presentations/raw/master/docs/EDAB_images/GOApcodESPrisk.png)
]

.footnote[

Pacific cod example from Alaska: https://www.fisheries.noaa.gov/alaska/2021-alaska-fisheries-science-center-year-review and https://apps-afsc.fisheries.noaa.gov/refm/docs/2021/GOApcod.pdf
]


???
Our ESP process was developed from the AFSC process, but we adjusted things slightly because of how our benchmarks are scheduled and because we are providing scientific advice to multiple Councils. 

The ESP framework is an iterative cycle that complements the stock assessment cycle. First I will give you an overview of the ESP cycle, and then I will explain each step in more detail. The ESP begins with the development of the problem statement by identifying the topics that the assessment working group and ESP team want to assess. This process includes a literature review or other method of gathering existing information on the stock, such as reviewing prior assessments and research recommendations. Next, a conceptual model is created that links important processes and pressures to stock performance. From these linkages, we develop indicators that can be used to monitor the system conditions. Next, the indicators are analyzed to determine their status and the likely impacts on the stock. Some indicators may be tested for inclusion in assessment models. Finally, all of these analyses are synthesized into a report card to provide general recommendations for fishery management.



---
## Northeast US Bluefish *Pomatomus saltatrix* ESP, reviewed December 2022

.pull-left[

![Bluefish ESP conceptual model](https://github.com/NOAA-EDAB/presentations/raw/master/docs/EDAB_images/bluefishconceptualmodel.png)
.contrib[Figure and table by Abigail Tyrell]
]

.pull-right[
![](https://github.com/NOAA-EDAB/presentations/raw/master/docs/EDAB_images/TOR1.svg)
]

The full ESP document is available as a working paper from the [stock assessment data portal](https://apps-nefsc.fisheries.noaa.gov/saw/sasi_files.php?year=2022&species_id=32&stock_id=6&review_type_id=5&info_type_id=5&map_type_id=&filename=WP%2001%20Tyrell%20etAl%202022%20-%20ESP.pdf) 

## Ecosystem considerations can apply to observation as well as population processes 

???

---
## What have we learned? New England Atlantic Herring as forage `r Cite(myBib,"deroba_dream_2018")`.
.pull-left-30[
Complex food web, generalist predators
- Weak individual predator response to many herring harvest control rules
- (Stronger predator response to changing herring growth)
- Herring is one of several important prey (36-40 in plot)
- Assessing multiple prey together will likely show stronger effects on predators
]
.pull-right-70[
![NEUSfw](https://github.com/NOAA-EDAB/presentations/raw/master/docs/EDAB_images/LinkNEUSfoodweb.png)
.contrib[The original "horrendogram" `r Cite(myBib,"link_does_2002")`]
]


---
## Extensions: Can forage indices link zooplankton and fish productivity?

.pull-left[

```{r ecodata}
#fishcond <- magick::image_read("https://github.com/NOAA-EDAB/presentations/raw/master/docs/EDAB_images/MAB_Condition_allsex_2022_viridis.jpg") 
#magick::image_trim(fishcond)

epu_abbr = "MAB"

```

```{r, code=readLines("https://raw.githubusercontent.com/NOAA-EDAB/ecodata/master/chunk-scripts/macrofauna_MAB.Rmd-productivity-anomaly.R"), fig.asp=.6}

```

.left[
```{r, code=readLines("https://raw.githubusercontent.com/NOAA-EDAB/ecodata/master/chunk-scripts/LTL_MAB.Rmd-zoo-abund.R"), out.width = "90%", fig.asp=.5}

```
]
]

.pull-right[

#### MAB

.center[
```{r MAforagebio, code=readLines("https://raw.githubusercontent.com/NOAA-EDAB/ecodata/master/chunk-scripts/macrofauna_MAB.Rmd-forage-index.R"), fig.asp=.6, out.width="70%"}
#fig.cap = "Forage fish index based on spring and fall survey predator diets in the Mid Atlantic.", 
```
]

#### NE
```{r NEforagebio, code=readLines("https://raw.githubusercontent.com/NOAA-EDAB/ecodata/master/chunk-scripts/macrofauna_NE.Rmd-forage-index.R"),  fig.asp=.5, out.width="100%"}
#fig.cap = "Forage fish index based on spring and fall survey predator diets on Georges Bank (GB) and in the Gulf of Maine (GOM).",
```

]

???
aggregate forage important in this system with many forage species: Jason Link horrendogram

potential trends in aggregate forage to be compared with trends in zooplankton and environmental drivers


---
background-image: url("https://github.com/NOAA-EDAB/presentations/raw/master/docs/EDAB_images/SOE-MA-draft-03.16.23_Page_3.png")
background-size: 500px
background-position: right

## Next steps

Update for 2024 ecosystem reporting

Benthic index for food web modeling, risk assessment

Improvements/exploration: 

*   Add predator functional response?

*   Multivariate model tracking prey groups?

*   Your ideas here!

---
## Thank you!  References

.contrib[
```{r refs, echo=FALSE, results="asis"}
PrintBibliography(myBib)
```
]

.footnote[
Slides available at https://noaa-edab.github.io/presentations  
Contact: <Sarah.Gaichas@noaa.gov>
]
