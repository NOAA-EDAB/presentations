---
title: "Assessing small pelagic fish trends in space<br /> and time using piscivore stomach contents"
subtitle: "Quantfish <br /> 15 October 2023"
author: Sarah Gaichas$^1$, James Gartland$^2$, Brian Smith$^1$, Anthony Wood$^1$, Elizabeth Ng$^3$,<br />  Michael Celestino$^4$, Katie Drew$^5$, Abigail Tyrell$^{1,6}$, and James Thorson$^7$ 
institute: <span style="font-weight:normal;"><font size="-0.5">$^1$NOAA NMFS Northeast Fisheries Science Center, Woods Hole, MA, USA; $^2$Virginia Institute of Marine Science, Gloucester Point, VA, USA; $^3$University of Washington, Seattle, WA, USA; $^4$New Jersey Department of Environmental Protection, Port Republic, NJ, USA; $^5$Atlantic States Marine Fisheries Commission, Arlington, VA, USA; $^6$Ocean Associates Inc, Arlington, VA, USA; $^7$NOAA NMFS Alaska Fisheries Science Center, Seattle, WA, USA</font></span>
output:
  xaringan::moon_reader:
    css: ["default", "libs/EDAB_theme3_508_SOE_16by9.css"]
    lib_dir: libs
    nature:
      titleSlideClass: ["right", "bottom", "my-title"]
      ratio: "16:9"
      highlightStyle: githubp
      highlightLines: true
      countIncrementalSlides: false
      beforeInit: "libs/macros.js"
  revealjs::revealjs_presentation:
    self_contained: false
    reveal_plugins: ["notes", "search"]
---
class: top, left

```{r setup, include=FALSE}

options(htmltools.dir.version = FALSE)
knitr::opts_chunk$set(echo = F,
                      fig.retina = 3,
                      warning = F,
                      message = F,
                      error = F)
knitr::knit_hooks$set(crop = knitr::hook_pdfcrop)
#Plotting and data libraries
library(tidyverse)
library(tidyr)
library(here)
library(sf)
```

```{r, load_refs, include=FALSE, cache=FALSE}
#trick to downlaod bib file from other repo to keep just 1 up to date

# url <- "https://raw.githubusercontent.com/sgaichas/bluefishdiet/main/FishDiet_EcoIndicators.bib"
#   download.file(url, destfile = "./FishDiet_Ecoindicators.bib")

library(RefManageR)
BibOptions(check.entries = FALSE,
           bib.style = "authoryear",
           cite.style = "authoryear",
           longnamesfirst = FALSE,
           max.names = 1,
           style = "markdown")
myBib <- ReadBib("./FishDiet_Ecoindicators.bib", check = FALSE)

#,
#           hyperlink = FALSE,
#           dashed = FALSE

```
background-image: url("https://github.com/NOAA-EDAB/presentations/raw/master/docs/EDAB_images/forageSeattleTimes.png"), url("https://github.com/NOAA-EDAB/presentations/raw/master/docs/EDAB_images/allcomponents.png")
background-size: 590px, 550px
background-position: top left, bottom right

.right[
# Motivation

Small pelagics as forage; 
Importance as a group  

How much?  
Where and when?  
Drive predator and fishery distributions  
]


???

Small pelagics are widely recognized for their critical function as forage, supporting human populations as well as harvested fish and protected species in ecosystems worldwide. In some ecosystems, one or two small pelagic species may dominate as forage , while in others a wide variety of small pelagic species fill this role together. In both instances, understanding fluctuations in small pelagics is an important component of an ecosystem approach to management: low abundance of small pelagics can have implications for both directed small pelagic fisheries and management of their predators. Conversely, high aggregate abundance of small pelagics can provide a robust forage supply for generalist predators even if individual small pelagic species are depleted. Fish predators generally select the most abundant prey in the environment, so as individual prey populations vary, fish predators respond by switching prey. 

In addition to abundance, spatial distribution of small pelagics has clear implications for both predators and fisheries.  Central place foragers such as seabirds require small pelagics close to breeding colonies during the breeding season, while free ranging highly mobile fish predators can follow small pelagics if their distributions shift further offshore.  Similarly, fisheries prosecuted on large vessels are better equipped to follow mobile predators offshore, while shore based artisanal and recreational fisheries may lose access to mobile predators that follow prey offshore. Changing spatial distribution can also impact stock assessments if changing availability of assessed fish cannot be incorporated into assessment models.   


---
# Does prey drive availability of bluefish?

## Bluefish, *Pomatomus saltatrix*

.pull-left[
![Bluefish illustration, credit NOAA Fisheries](https://media.fisheries.noaa.gov/styles/original/s3/2022-08/640x427-Bluefish-NOAAFisheries.png)
]

.pull-right[
.large[

"... it is perhaps the most ferocious and bloodthirsty fish in the sea, leaving in its wake a trail of dead and mangled mackerel, menhaden, herring, alewives, and other species on which it preys." `r Cite(myBib, "collette_bigelow_2002")`

"From Raritan Bay to Rockaway Inlet, we have had a phenomenal bluefish year with lots of bunker and other bait, ultimately leading to an abundance of bluefish." [Mid-Atlantic Bluefish Fishery Performance Report, 2021](https://www.mafmc.org/s/8_BF-FPR-2021.pdf)

]
]

.center[
Can localized predator-prey observations scale to coastwide assessment and management? 
]

???
<font size="-1"></font>

Changing distribution and abundance of small pelagics may drive changes in predator distributions, affecting predator availability to fisheries and surveys.Bluefish are medium-sized, rapidly growing pelagic piscivores known to prey on a wide variety of small pelagics and to target areas of dense prey. Participants in the US bluefish fishery have raised concerns that changes in prey distribution may change bluefish availability to surveys and recreational fisheries, creating uncertainty in stock assessments and subsequent fishery management ([MAFMC Fishery performance report, 2021](https://www.mafmc.org/s/8_BF-FPR-2021.pdf)). Therefore, spatial and temporal trends in the small pelagic prey of bluefish needed to be characterized to address this concern. 

---
## Objective

Create a “forage index” to evaluate changes in small pelagics  over time and in space in the Northeast US continental shelf ecosystem.

Two applications: 

1. addressing uncertainty in the stock assessment for a key predator species, bluefish (*Pomatomus saltatrix*), and 

1. describing aggregate forage species trends for integrated ecosystem assessment

---
# Northeast US: How much? Where and when?

.pull-left[
## Stock assessments ([ASMFC](http://www.asmfc.org/species/atlantic-menhaden),  [StockSmart](https://apps-st.fisheries.noaa.gov/stocksmart?app=homepage))

![](https://github.com/NOAA-EDAB/presentations/raw/master/docs/EDAB_images/herrmackmenhaden_assess.png)
]

.pull-right[
## Bottom trawl survey "planktivores" abundance estimates ([Northeast US Ecosystem Reports](https://www.fisheries.noaa.gov/new-england-mid-atlantic/ecosystems/state-ecosystem-reports-northeast-us-shelf))

```{r, fig.asp=0.85, out.width="95%", results='hide'}

# code modified from Kim Bastille's ecodata macrofauna_MAB.Rmd

#Time series constants
shade.alpha <- 0.3
shade.fill <- "lightgrey"
lwd <- 1
pcex <- 2
trend.alpha <- 0.5
trend.size <- 2
hline.size <- 1
hline.alpha <- 0.35
hline.lty <- "dashed"
label.size <- 5
hjust.label <- 1.5
letter_size <- 4
feeding.guilds <- c("Apex Predator","Piscivore","Planktivore","Benthivore","Benthos")
x.shade.min <- 2012
x.shade.max <- 2022
series.col <- c("indianred","black")
#Function for custom ggplot facet labels
label <- function(variable,value){
  return(facet_names[value])
}

planktivores <- ecodata::aggregate_biomass %>%
  dplyr::filter(Var %in% c("Planktivore Fall Biomass Index",
                           "Planktivore Spring Biomass Index",
                           "Planktivore Fall Biomass Standard Error",
                           "Planktivore Spring Biomass Standard Error"))%>%
  tidyr::separate(Var, c("feeding.guild", "season", "Biomass", "Var1"), sep = " ") %>% #, "Null", "Area"
  tidyr::unite("Var", feeding.guild:season, sep = " ") %>%
  dplyr::mutate(stat = recode(Var1, Index = "Mean",
                      Standard = "SD"),
                Value = as.numeric(Value),
                Time = as.integer(Time)) %>%
  dplyr::select(-Biomass, -Var1,  -Units) %>% #-Null,
  # dplyr::filter(!Area == "-") %>%
  dplyr::group_by(Var, Time, EPU) %>% #, Area
  tidyr::pivot_wider(names_from =  stat, values_from =  Value) %>% #, Area id_cols = c(Var, Time, EPU)
  tidyr::unnest(cols = c(Mean, SD))
  #dplyr::filter(!Mean == "NULL") %>%
  #dplyr::ungroup() #%>%
  #dplyr::mutate(Mean = as.numeric(Mean))


agg_bio<-planktivores %>% dplyr::filter(EPU %in% c("MAB", "GB", "GOM"),
         Time >= 1968) %>%
  dplyr::group_by(Var, EPU) %>%
  dplyr::mutate(hline = mean(Mean, na.rm = T), 
                 upper = Mean + (2*SD),
                lower = Mean - (2*SD)) %>%
  dplyr::ungroup()  
 

agg_bio$Var <- factor(agg_bio$Var,levels = c("Planktivore Spring",
                                                    "Planktivore Fall"))
series.col <- rep("black",length(unique(agg_bio$Var)))
facet_names <- list("Planktivores" = expression("Planktivores")
                    )
#Get NEAMAP
neamap <- ecodata::mab_inshore_survey %>%
  tidyr::separate(Var, into = c("Var",  "Val"), sep = "-") %>% 
  tidyr::pivot_wider(names_from = Val, values_from = Value) %>% 
  dplyr::mutate(Value = as.numeric(Value), 
                CV = as.numeric(CV)) %>% 
  dplyr::group_by(Var) %>%
  dplyr::mutate(hline = mean(Value),
         SD = Value * CV, #calculate SD from CV
         upper = Value + (2*SD),
         lower = Value - (2*SD))

neamap$Var <- factor(neamap$Var,levels = c("Piscivore Spring","Piscivore Fall",
                                           "Benthivore Spring", "Benthivore Fall",
                                           "Planktivore Spring", "Planktivore Fall",
                                           "Benthos Spring", "Benthos Fall"))

### Planktivore
neamap.3<-neamap %>%
  dplyr::filter(str_detect(Var,"Planktivore"))
p3<-agg_bio %>%
  dplyr::filter(str_detect(Var,"Planktivore")) %>%
  ggplot2::ggplot() +

  #Highlight last ten years
  ggplot2::annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max ,
      ymin = -Inf, ymax = Inf) +
  #Test for trend and add lines
  ecodata::geom_gls(aes(x = Time, y = Mean,
               color = Var),
             alpha = trend.alpha, size = trend.size) +
  ecodata::geom_lm(aes(x = Time, y = Mean,
               color = Var),
             alpha = trend.alpha, size = trend.size) +
  #ecodata::geom_lm(aes(x = Time, y = Mean))+

  #Add time series
  ggplot2::geom_ribbon(aes(x = Time, ymin = pmax(lower,0), ymax = upper),
              alpha = 0.5,
              fill = "grey") +
  ggplot2::geom_line(aes(x = Time, y = Mean),size = lwd-0.5) +
  ggplot2::geom_point(aes(x = Time, y = Mean),size = pcex-0.5) +
  ggplot2::scale_color_manual(values = series.col, aesthetics = "color")+
  ggplot2::guides(color = FALSE) +
  ggplot2::geom_hline(aes(yintercept = hline,
                 group = Var),
             size = hline.size,
             alpha = hline.alpha,
             linetype = hline.lty)+
  ggplot2::facet_wrap(EPU ~ Var~.,ncol = 2, scales = "free_y") +
       #Add NEAMAP
  ggplot2::geom_ribbon(data = neamap.3, aes(ymax = pmax(upper, 0), ymin = lower, x = Time),
                fill = "pink", alpha = 0.5) +
  ggplot2::geom_line(data = neamap.3, aes(x = Time, y = Value),
            color = "#ca0020")+
  ggplot2::geom_point(data = neamap.3, aes(x = Time, y = Value),
             size = pcex-0.5,
             color = "#ca0020")+

  #Axis and theme
  ggplot2::scale_x_continuous(breaks = seq(1970, 2020, by = 10), expand = c(0.01, 0.01)) +
  #ylim(0, 600)+
  ggplot2::ylab(expression("Biomass (kg tow"^-1*")")) +
  ecodata::theme_facet()+
  ggplot2::theme(strip.text=element_text(hjust=0),
        axis.title.x=element_blank())

p3

```
]

???

Bottom trawls are not designed for efficient sampling of small pelagics. While we can estimate aggregate planktivore biomass for different ecoregions on the Northeast US shelf, estimates have high observation error. Black lines = NEFSC bottom trawl, Red lines = NEAMAP inshore bottom trawl. Orange line on GB Fall indicates significant increasing long term trend.

Many exploited small pelagic populations have a long history of scientific assessment, providing insight into long term and short term fluctuations relevant to both the fishery and the wider ecosystem. However, spatial shifts within a small pelagic stock’s range affecting different predator populations and distributions are difficult to track using conventional spatially aggregated stock assessment approaches. In addition, for ecosystems where small pelagics represent a mix of managed and unmanaged species, information on unmanaged species is often lacking, hindering assessment of the status of the full forage base supporting predators and other fisheries.

---
background-image: url("https://github.com/NOAA-EDAB/presentations/raw/master/docs/EDAB_images/Ng2022dietvsassess.png"), url("https://github.com/NOAA-EDAB/presentations/raw/master/docs/EDAB_images/NgPredStomForageB2022.png")
background-size: 800px, 400px
background-position: right, left

## Fish stomach contents &rarr; Atlantic herring biomass estimates `r Cite(myBib, "ng_predator_2021")`

<!--.pull-left-40[
![:img Ng paper title](https://github.com/NOAA-EDAB/presentations/raw/master/docs/EDAB_images/NgPredStomForageB2022.png)
]

.pull-right-60[]-->
???

---
## Outline

1. Vector Autoregressive Spatio-Temporal (VAST) modeling

1. Identify forage species: what are bluefish prey?

1. Can we use predators as "samplers"? Which predators?

1. What affects the sampling process? Covariates

1. Which model is best? Selection

1. Index sensitivity

1. Stock assessment application

---
## Vector Autoregressive Spatio-Temporal (VAST) modeling `r Cite(myBib, c("thorson_comparing_2017", "thorson_guidance_2019"))`

VAST is a Geostatistical generalized linear mixed effects model (GLMM) that models two linear predictors for an index: 1. encounter rate,  and 2. positive catch (amount in stomach)

A full model for the first linear predictor $\rho_1$ for each observation $i$ can include:
*  fixed intercepts $\beta_1$ for each category $c$ and time $t$, 
*  spatial random effects $\omega_1$ for each location $s$ and category, 
*  spatio-temporal random effects $\varepsilon_1$ for each location, category, and time, 
*  fixed vessel effects $\eta_1$ by vessel $v$ and category, and 
*  fixed catchability impacts $\lambda_1$ of covariates $Q$ for each observation and variable $k$: 

$$\rho_1(i) = \beta_1(c_i, t_i) + \omega_1^*(s_i, c_i) + \varepsilon_1^*(s_i, c_i, t_i) + \eta_1(v_i, c_i) + \sum_{k=1}^{n_k} \lambda_1(k) Q(i,k)$$ 

The full model for the second linear predictor $\rho_2$ has the same structure, estimating $\beta_2$, $\omega_2$, $\varepsilon_2$, $\eta_2$, and $\lambda_2$ using the observations, categories, locations, times, and covariates. 

We modeled aggregate small pelagic prey as a single category, and apply a Poisson-link delta model to estimate expected prey mass per predator stomach as in `r Cite(myBib, "ng_predator_2021")`.

VAST model code and documentation: https://github.com/James-Thorson-NOAA/VAST


???
Spatial and spatio-temporal correlation decay with increasing distance estimated as $\kappa$ in a Matern function with fixed smoothness and geometric anisotropy (directional correlation, optionally estimated by the model). 

Initial model selection consistently supported the inclusion of spatial and spatio-temporal random effects and anisotropy across all datasets: fall, spring, and annual. 

---
.pull-left-30[
## Spatial estimation assumptions

VAST has built-in "extrapolation grids" for many surveyed areas, including the Northeast US.

Observations in space are used to define fixed locations ("knots") covering the full extent of the model. We assume constant variation within a timestep at a knot. 

Modelers specify the number of knots to group observation locations, to balance computation time and resolution. We used 500 knots:  
]

.pull-right-70[
![:img fall forage index knots, 90%](https://github.com/NOAA-EDAB/presentations/raw/master/docs/EDAB_images/Data_and_knots.png)
]

???
Extrapolation grid:" area over which densities will be extrapolated to calculate derived quantities" encompassing survey area allows comparison with design-based estimates

Knots are defined that "minimize the average distance between samples and knots" using k-means clustering, which results in knots in proportion to sampling intensity across the area.


---
## Modeling spatial and spatio-temporal variation

.pull-left-60[
Observations correlated in space and in space over time due to unmeasured processes are modeled as multivariate normal Gaussian Random Fields (GRF):

$\omega_1$ ~ MVN(0, $\mathbf R_1$); $\omega_2$ ~ MVN(0, $\mathbf R_2$)   
$\varepsilon_1$(,t) ~ MVN(0, $\mathbf R_1$); $\varepsilon_2$(,t) ~ MVN(0, $\mathbf R_2$) 

Spatial and spatio-temporal correlation decay with increasing distance $\mathbf d$ estimated as $\kappa$ in a Mat&eacute;rn function with fixed smoothness $\nu$ and geometric anisotropy $H$ (directional correlation). 
  
Correlation function between locations $s$ and $s'$:

$$\mathbf R_1(s, s') = \frac{1}{2^{\nu-1}\Gamma(\nu)} \times (\kappa_1 \lvert \mathbf d(s,s') \mathbf H  \rvert)^\nu \times K_\nu (\kappa_1 \lvert \mathbf d(s,s') \mathbf H  \rvert)$$

Estimation uses stochastic partial differential equation (SPDE) approximation to GRF.

]

.pull-right-40[

![:img fall forage index aniso, 85%](https://github.com/NOAA-EDAB/presentations/raw/master/docs/EDAB_images/Aniso.png)

]


---
## Estimating density in space and the index



---
## Defining bluefish prey from stomachs: a mix of managed and unmanaged small pelagics 

.pull-left-30[
```{r, crop=TRUE, fig.show='hold', out.width="45%"}

knitr::include_graphics("https://media.fisheries.noaa.gov/styles/original/s3/2022-08/640x427-Squid-Longfin-v1-NOAAFisheries.png")
#credit: NOAA fisheries

knitr::include_graphics("https://objects.liquidweb.services/images/201909/robert_aguilar,_serc_48650727166_3ce8edc47d_b.jpg")
#credit: Robert Aguilar, Smithsonian Environmental Research Center

knitr::include_graphics("https://media.fisheries.noaa.gov/styles/original/s3/2022-08/640x427-Butterfish-NOAAFisheries.png")
#credit: NOAA fisheries

knitr::include_graphics("https://images.marinespecies.org/thumbs/31939_ammodytes.jpg?w=700")
#credit: Canadian register of marine species https://www.marinespecies.org/carms/photogallery.php?album=1487&pic=31939

knitr::include_graphics("https://media.fisheries.noaa.gov/styles/original/s3/2022-08/640x427-Mackerel-Atlantic-NOAAFisheries.png")
#credit: NOAA fisheries

knitr::include_graphics("https://media.fisheries.noaa.gov/styles/original/s3/2022-08/640x427-Herring-Atlantic-NOAAFisheries.png")
#credit: NOAA fisheries

knitr::include_graphics("https://www.fishbase.se/images/thumbnails/jpg/tn_Etter_u2.jpg") 
#credit:  Fishbase

knitr::include_graphics("https://media.fisheries.noaa.gov/styles/original/s3/2022-09/640x427-Hake-Silver-NOAAFisheries.png")
#credit: NOAA fisheries

knitr::include_graphics("https://media.fisheries.noaa.gov/styles/original/s3/2021-03/squid_illex_nb_w_0.png")
#credit: NOAA fisheries

knitr::include_graphics("https://media.fisheries.noaa.gov/styles/original/s3/2021-01/640x427-Atlantic_Menhaden_NB_W.jpg")
#credit: NOAA fisheries

```
.contrib[
Northeast Fisheries Science Center Diet Data Online: https://fwdp.shinyapps.io/tm2020/
]
]

.pull-right-70[

```{r, fig.width = 10.5, fig.asp=.8}

#These three lines run from NOAA-EDAB/forageindex main then copied NEFSCbluefishdietraw.rds to data folder here
#source(here("get_diet.R"))
#bluefish <- get_diet(135)
#saveRDS(bluefish, here("NEFSCbluefishdietraw.rds"))

bluefishdietraw <- readRDS(here::here("data/NEFSCbluefishdietraw.rds"))

# run lines 157-235 in NOAA-EDAB/forageindex main Bluefish_forageindex_CJFAS.Rmd, save blueprey as csv
blueprey <- read.csv(here::here("data/blueprey.csv"))

# try for facet decade/season with included prey highlighted in blue
bluefishdecseastot <- bluefishdietraw %>%
  # make decade column
  # make 2 seasons winter--> spring and summer--> fall
  dplyr::mutate(decade = floor(year/10)*10,
                season2 = case_when(season %in% c("WINTER", "SPRING") ~ "SPRING",
                                    season %in% c("SUMMER", "FALL") ~ "FALL")) %>%
                #season2 = case_when(season %in% c( "SPRING") ~ "SPRING",
                #                    season %in% c( "FALL") ~ "FALL")) %>%
  dplyr::select(decade, season2, totwt) %>%
  dplyr::distinct() %>%
  dplyr::group_by(decade, season2) %>%
  dplyr::mutate(totwt2 = sum(totwt, na.rm = TRUE),
                nyrs = n_distinct(year)) %>%
  dplyr::select(decade, season2, totwt2, nyrs) %>%
  dplyr::distinct()

briansdat <- read.csv("https://raw.githubusercontent.com/NOAA-EDAB/forageindex/main/fhdat/allwt_135_seas_dec.csv")

# add blueprey list
briansdecadeseason <- briansdat %>%
  dplyr::mutate(blueprey = ifelse(collsci %in% blueprey$pynam, TRUE, FALSE),
                plotcol = ifelse(blueprey, "blue", "lightgrey"),
                decade = as.integer(gsub("s","",decade))) %>%
  dplyr::left_join(bluefishdecseastot, by=c("seacat" = "season2", 
                                            "decade" = "decade")) %>%
  dplyr::group_by(decade, seacat) %>%
  dplyr::filter(meansw>0) %>%
  dplyr::arrange(desc(blueprey), .by_group = TRUE)


bars <- map(unique(briansdecadeseason$decade)
            , ~geom_bar(aes(width=nyrs), stat = "identity", colour = "white"#, position = "stack", 
                       , data = briansdecadeseason %>% filter(decade == .x)))


p2 <-   ggplot(briansdecadeseason, aes(decade, relmsw, fill=blueprey)) +
                                    #fill=factor(prey, 
                                    #            levels = c(as.factor(names(preycolaggsel)),
                                    #                       setdiff(prey, preycolaggsel)),
                                    #           ordered = TRUE
                                    #           ))) +
   #geom_bar(aes(width=nyrs), stat = "identity") + #
   bars +
   ylab("Percent in Diet") +
   xlab("Decade") +
   geom_text(aes(y=relmsw, 
             label = ifelse(relmsw > 3, collsci, "")),
             position = position_stack(vjust = 0.5),
             size=2.5)+
   facet_wrap(~fct_relevel(seacat, "SPRING", "FALL")) +
   theme_bw() +
   #viridis::scale_fill_viridis(discrete = TRUE) +
   scale_fill_manual(values=c( "grey90", "lightblue")) + 
   theme(legend.position = "none"
         #legend.position="bottom",
         #legend.text=element_text(size=5)
         ) #+
    #geom_bar_interactive(stat = "identity", aes(tooltip = prey, data_id = prey))

#ggiraph(code = print(p1)) 
#p1

p2



```

] 


???
Using NEFSC bottom trawl survey diet data from 1973-2021, 20 small pelagic groups were identified as major bluefish prey with 10 or more observations (in descending order of observations): Longfin squids (*Doryteuthis* formerly *Loligo* sp.), Anchovy family (Engraulidae), bay anchovy (*Anchoa mitchilli*), Atlantic butterfish, (*Peprilus triachanthus*), Cephalopoda, (*Anchoa hepsetus*), red eye round herring (*Etrumeus teres*), Sandlance (*Ammodytes* sp.), scup (*Stenotomus chrysops*), silver hake (*Merluccius bilinearis*), shortfin squids (*Illex* sp.), Atlantic herring (*Clupea harengus*), Herring family (Clupeidae), Bluefish (*Pomatomus saltatrix*), silver anchovy (*Engraulis eurystole*), longfin inshore squid (*Doryteuthis pealeii*), Atlantic mackerel (*Scomber scombrus*), flatfish (Pleuronectiformes), weakfish (*Cynoscion regalis*), and Atlantic menhaden (*Brevoortia tyrannus*). 

Prey categories such as fish unidentified, Osteichthyes, and unidentified animal remains were not included in the prey list. Although unidentified fish and Osteichthyes can comprise a significant portion of bluefish stomach contents, we cannot assume that unidentified fish in other predator stomachs represent unidentified fish in bluefish stomachs.  

Image credits: Striped and bay anchovy photo--Robert Aguilar, Smithsonian Environmental Research Center; redeye round herring photo--https://diveary.com ; sandlance photo--Virginia Institute of Marine Science; all others NOAA Fisheries.


---
background-image: url("https://github.com/NOAA-EDAB/presentations/raw/master/docs/EDAB_images/BluefishOnlyFallData_by_year.png")
background-size: 650px
background-position: right top

## Which predators: Bluefish stomachs only?

.pull-left[
Due to uneven "sampling" of Atlantic herring by predators, `r Citep(myBib, "ng_predator_2021")` recommended aggregating across predators to improve the diet-based Atlantic herring biomass index. 

Between 1985-2021 there were: 
.contrib[

*  25634 survey stations with diet collections. 
*  22751 survey stations with piscivore diets. 
    +  9027 piscivore stations with bluefish prey; 
    +  40% of piscivore stations have bluefish prey. 
*  1814 survey stations with bluefish diets. 
    +  905 bluefish stations with bluefish prey;
    +  50% of bluefish stations have bluefish prey.
    
]
For this index combining multiple small pelagic prey, aggregating across predators most similar to bluefish both increases sample size and reduces sampling variability due to different predator availability to surveys.
]

.pull-right[

<!--![Fall bluefish NEFSC](https://github.com/NOAA-EDAB/presentations/raw/master/docs/EDAB_images/BluefishOnlyFallData_by_year.png) -->
.center[
.footnote[
Bluefish diet collection stations, fall Northeast Fisheries Science Center surveys
]
]

]
???
The figure shows bluefish diet collection stations for fall surveys, 1985-2019. 

NEAMAP survey stations with diet collections for piscivores (n = 3838) had a higher proportion with our defined bluefish prey (n = 2418, 63.0015633%).
---
## Aggregating predators: diet similarity to bluefish

.pull-left[
```{r, fig.asp=1}
dietoverlap <- read_csv("https://raw.githubusercontent.com/sgaichas/bluefishdiet/main/datfromshiny/tgmat.2022-02-15.csv")

library(dendextend)

d_dietoverlap <- dist(dietoverlap)

guilds <- hclust(d_dietoverlap)

#plot(guilds)

dend <- as.dendrogram(guilds)

dend <- rotate(dend, 1:136)

dend <- color_branches(dend, k=6)

dend <- color_labels(dend, k=6)

labels(dend) <- paste(as.character(names(dietoverlap[-1]))[order.dendrogram(dend)],
                           "(",labels(dend),")", 
                           sep = "")

dend <- hang.dendrogram(dend,hang_height=0.1)

# reduce the size of the labels:
# dend <- assign_values_to_leaves_nodePar(dend, 0.5, "lab.cex")
dend <- set(dend, "labels_cex", 0.75)
# And plot:
# par(mar = c(3,3,3,7))
# plot(dend, 
#      main = "Clustered NEFSC diet data, (complete)
#      (the labels give the predator species/size)", 
#      horiz =  TRUE,  nodePar = list(cex = .007))

circlize::circos.par(start.degree = 90)
par(mar = rep(0,4))
circlize_dendrogram(dend,
                    labels_track_height=0.3,
                    dend_track_height = 0.6)
```
]

.pull-right[
```{r, crop=TRUE, fig.show='hold', out.width="25%"}

knitr::include_graphics("https://media.fisheries.noaa.gov/styles/original/s3/2022-08/640x427-Bluefish-NOAAFisheries.png")

knitr::include_graphics("https://media.fisheries.noaa.gov/styles/original/s3/2022-07/640x427-Cod-Atlantic-NOAAFisheries.png?itok=kNKcZ7iV")

knitr::include_graphics("https://media.fisheries.noaa.gov/styles/original/s3/2022-08/640x427-Shark-SpinyDogfish-NOAAFisheries.png?itok=cdjTG3Hz")

knitr::include_graphics("https://media.fisheries.noaa.gov/styles/original/s3/2022-09/640x427-Monkfish-NOAAFisheries.png?itok=7JAgAz-u")

knitr::include_graphics("https://media.fisheries.noaa.gov/styles/original/s3/2022-09/640x427-Flounder-Summer-NOAAFisheries.png?itok=II2ii-Qw")

knitr::include_graphics("https://media.fisheries.noaa.gov/styles/original/s3/2022-08/640x427-Pollock-Atlantic-NOAAFisheries.png?itok=ZFoDB-Qr")

knitr::include_graphics("https://media.fisheries.noaa.gov/styles/original/s3/2022-09/640x427-Hake-Red-NOAAFisheries.png?itok=SyCYEmmm")

knitr::include_graphics("https://media.fisheries.noaa.gov/styles/original/s3/2022-08/640x427-Halibut-Atlantic-right-NOAAFisheries.png?itok=uPvRdIBx")

knitr::include_graphics("https://media.fisheries.noaa.gov/styles/original/s3/2022-08/640x427-StripedBass-NOAAFisheries.png?itok=4ZQoQM0S")

knitr::include_graphics("https://media.fisheries.noaa.gov/styles/original/s3/2020-12/640x427-Hake_White_NB_W.jpg?itok=yHy_AuTT")

knitr::include_graphics("https://media.fisheries.noaa.gov/styles/original/s3/2022-09/640x427-Hake-Silver-NOAAFisheries.png")

knitr::include_graphics("https://media.fisheries.noaa.gov/styles/original/s3/dam-migration/640x427-cusk.jpg?itok=u0fw0hiv")

knitr::include_graphics("https://media.fisheries.noaa.gov/styles/original/s3/2022-08/640x427-Squid-Longfin-v1-NOAAFisheries.png")

knitr::include_graphics("https://media.fisheries.noaa.gov/styles/original/s3/2021-03/squid_illex_nb_w_0.png")

#knitr::include_graphics("https://marinefishesofgeorgia.org/wp-content/themes/yootheme/cache/Weakfish-00ce3893.png")
knitr::include_graphics("https://github.com/NOAA-EDAB/presentations/raw/master/docs/EDAB_images/weakfishASMFC.png")
# credit: https://marinefishesofgeorgia.org/weakfish/

knitr::include_graphics("https://photolib.noaa.gov/Portals/0//GravityImages/36881/ProportionalFixedWidth/sanc100698384x800x800.jpg")
#A Sea Raven - Hemitripterus americanus2/11/2019 11:07:56 AM, Photographer: Andrew J. Martinez, Location: Massachusetts, Stellwagen Bank NMS


```

```{r, crop=TRUE, fig.show='hold', out.width="25%"}

# fourspot flounder, spotted hake no good pics

thorny <- magick::image_read("https://media.fisheries.noaa.gov/dam-migration/thorny.jpg")
magick::image_rotate(thorny, 90)

#knitr::include_graphics("https://apps-nefsc.fisheries.noaa.gov/rcb/photogallery/large/dory_fullsize.jpg")
# credit: NOAA NEFSC https://apps-nefsc.fisheries.noaa.gov/rcb/photogallery/pelagic.html

knitr::include_graphics("https://github.com/NOAA-EDAB/presentations/raw/master/docs/EDAB_images/depositphotos_7476236-stock-photo-zeus-faber-fish.jpg")

#knitr::include_graphics("https://marinefishesofgeorgia.org/wp-content/themes/yootheme/cache/Spanish-Mackerel-7c44a9e9.png")
# credit: https://marinefishesofgeorgia.org/spanish-mackerel/

knitr::include_graphics("https://github.com/NOAA-EDAB/presentations/raw/master/docs/EDAB_images/spanishmackerelASMFC.png")

#knitr::include_graphics("https://files.nc.gov/deq/styles/site_page_main_image/public/images/2021-10/Cynoscion-nebulosus-white.jpg")
# credit: https://deq.nc.gov/about/divisions/marine-fisheries/public-information-and-education/species-profiles/spotted-seatrout

knitr::include_graphics("https://github.com/NOAA-EDAB/presentations/raw/master/docs/EDAB_images/spottedseatroutASMFC.png")

```

]

???
All size classes of 50 fish predators captured in the NEFSC bottom trawl survey were grouped by diet similarity to identify the size classes of piscivore species with the most similar diet to bluefish in the region.  Diet similarity analysis was completed using the Schoener similarity index (@schoener_nonsynchronous_1970; B. Smith, pers. comm.), and is available available via [this link on the NEFSC food habits shiny app](https://fwdp.shinyapps.io/tm2020/#4_DIET_OVERLAP_AND_TROPHIC_GUILDS). The working group evaluated several clustering methods to develop the predator list (see [this link with detailed cluster results](https://sgaichas.github.io/bluefishdiet/PreySimilarityUpdate.html)). 

Predators with highest diet similarity to Bluefish from the NEFSC diet database (1973-2020) include Atlantic cod, Atlantic halibut, buckler dory, cusk, fourspot flounder, goosefish, longfin squid, shortfin squid, pollock, red hake, sea raven, silver hake, spiny dogfish, spotted hake, striped bass, summer flounder, thorny skate, weakfish, and white hake. The NEAMAP survey operates closer to shore than the current NEFSC survey. The NEAMAP dataset includes predators sampled by the NEFSC survey and adds two species, Spanish mackerel and spotted sea trout, not captured by the NEFSC survey offshore but included based on working group expert judgement of prey similarity to bluefish. Predator size classes included are listed in Table 2 of the forage fish index working paper at [this link](https://sgaichas.github.io/bluefishdiet/VASTcovariates_forageindex_WP.html). 

Image credits: Weakfish and Spanish mackerel-- https://marinefishesofgeorgia.org ; spotted seatrout-- https://fishinginmiami.com ; Sea Raven photo 2/11/2019 11:07:56 AM, Photographer: Andrew J. Martinez, Location: Massachusetts, Stellwagen Bank NMS; all others NOAA Fisheries.

---
background-image: url("https://github.com/NOAA-EDAB/presentations/raw/master/docs/EDAB_images/AllPiscivoresFallData_by_year.png")
background-size: 600px
background-position: right top

.pull-left[
## "Catchability" covariates for aggregate predator samplers at a location

Number of predator species &rarr; likely to affect *encounter rate*

Mean size of predators &rarr; likely to affect *amount of prey* `r Cite(myBib, "ng_predator_2021")`

Sea surface temperature (SST) &rarr; likely to affect predator activity and feeding rate *encounter rate and amount of prey*

*  Many missing SST measurements for surveys before 1991
*  NOAA OI SST V2 High Resolution Dataset `r Cite(myBib, "reynolds_daily_2007")` filled gaps

Model selection consistently included number of predator species, mean predator size, and SST as covariates using fall, spring, and annual datasets
]

.pull-right[
]
.footnote[
All piscivore diet collection stations, fall Northeast Fisheries Science Center surveys &rarr;
]


???
Diets from all 22 piscivores (including bluefish) were combined for the 20 forage fish (bluefish prey) groups at each surveyed location, and the mean weight of forage fish per predator stomach at each location was calculated. Data for each station included station ID, year, season, date, latitude, longitude, vessel, mean bluefish prey weight (g), mean piscivore length (cm), number of piscivore species, and sea surface temperature (degrees C). Because approximately 10% of survey stations were missing in-situ sea water temperature measurements, National Oceanic and Atmospheric Administration Optimum Interpolation Sea Surface Temperature (NOAA OI SST) V2 High Resolution Dataset [@reynolds_daily_2007] data provided by the NOAA PSL, Boulder, Colorado, USA, from their website at https://psl.noaa.gov were used to fill gaps. For survey stations with in-situ temperature measurements, the in-situ measurement was retained. For survey stations with missing temperature data, OI SST was substituted for input into VAST models.

Models were developed combining all data for the year ("Annual") and with separate data for "Spring" (collection months January - June) and "Fall" (collection months July-December) to align with assumptions used in the bluefish stock assessment. Modeled years included 1985-2021 to align with other data inputs in the bluefish stock assessment. 

SST is also likely to affect prey distribution, but differently for each prey species. Therefore, SST is not modeled as a density covariate for aggregate small pelagics.

---
## Spatial partitioning: examining small pelagics trends at multiple scales

```{r}

# 3nm buffer
coast3nmbuff <- readRDS(url("https://github.com/sgaichas/bluefishdiet/raw/main/spatialdat/neus_coast3nmbuff.rds"))

fedwaters <- setdiff(FishStatsUtils::northwest_atlantic_grid, coast3nmbuff)


#current bluefish assessment strata are all Bigelow inshore strata MAB-GB
bfinshore <- c(3020, 3050, 3080, 3110, 3140, 3170, 3200, 3230, 
              3260, 3290, 3320, 3350, 3380, 3410, 3440, 3450, 3460)

bfinshoregrid <-  FishStatsUtils::northwest_atlantic_grid %>%
  filter(stratum_number %in% bfinshore)
  
  
# from Tony's 8 March presentation, minus the inshore in CCBay
bfoffshore <- c(1010, 1730, 1690, 1650, 1050, 1060, 1090, 1100, 1250, 1200, 1190, 1610)

bfoffshoregrid <-  FishStatsUtils::northwest_atlantic_grid %>%
  filter(stratum_number %in% bfoffshore)

#from mskeyrun vignette, EPU based on survey strata, replace built in VAST EPU
#https://noaa-edab.github.io/ms-keyrun/articles/GBSurveySet.html

MAB <- c(1010:1080, 1100:1120, 1600:1750, 3010:3450, 3470, 3500, 3510)
GB  <- c(1090, 1130:1210, 1230, 1250, 3460, 3480, 3490, 3520:3550)

MABGBgrid <-  FishStatsUtils::northwest_atlantic_grid %>%
  filter(stratum_number %in% c(MAB, GB))

albinshoregrid <- MABGBgrid %>%
  filter(stratum_number>2999 & stratum_number<3999) %>% #inshore
  anti_join(bfinshoregrid)

othoffshoregrid <- MABGBgrid %>%
  anti_join(bind_rows(albinshoregrid, bfinshoregrid, bfoffshoregrid))

statewatersgrid <- coast3nmbuff %>%
  inner_join(MABGBgrid)

fedwatersgrid <- fedwaters %>%
  inner_join(MABGBgrid)

allinshoregrid <- MABGBgrid %>%
  filter(stratum_number>2999 & stratum_number<3999) #combines albatross and bigelow inshore

```

```{r maps, crop=TRUE, fig.cap="Maps of key areas for Bluefish assessment indices. The full VAST model grid is shown in brown.", fig.show='hold', out.width="33%"}

theme_set(theme_bw())

ggplot(data = ecodata::coast) +
  geom_sf() + 
  geom_point(data = FishStatsUtils::northwest_atlantic_grid, aes(x = Lon, y = Lat),  colour = "coral4", size=0.05, alpha=0.1) +
  geom_point(data = MABGBgrid, aes(x = Lon, y = Lat), size=0.05, colour = "green",  alpha=0.1) +
  #coord_sf(xlim = c(-79, -65.5), ylim = c(33, 45)) + #full extent of VAST model
  coord_sf(xlim =c(-78, -65.5), ylim = c(35, 45)) + #zoomed to Hatteras and N
  ggtitle("Mid Atlantic and Georges Bank (green), general bluefish range")


ggplot(data = ecodata::coast) +
  geom_sf() + 
  geom_point(data = FishStatsUtils::northwest_atlantic_grid, aes(x = Lon, y = Lat),  colour = "coral4", size=0.05, alpha=0.1) +
  geom_point(data = MABGBgrid, aes(x = Lon, y = Lat), size=0.05, colour = "green",  alpha=0.1) +
  geom_point(data = albinshoregrid, aes(x = Lon, y = Lat), size=0.03, colour = "blue") +
  geom_point(data = bfinshoregrid, aes(x = Lon, y = Lat), size=0.05, colour = "blue",  alpha=0.3) +
  geom_point(data = bfoffshoregrid, aes(x = Lon, y = Lat), size=0.05, colour = "orange",  alpha=0.3) +
  #coord_sf(xlim = c(-79, -65.5), ylim = c(33, 45)) +
  coord_sf(xlim =c(-78, -65.5), ylim = c(35, 45)) +
  ggtitle("Inshore (dark and light blue) and offshore (orange) bluefish survey strata")

ggplot(data = ecodata::coast) +
  geom_sf() + 
  geom_point(data = FishStatsUtils::northwest_atlantic_grid, aes(x = Lon, y = Lat),  colour = "coral4", size=0.05, alpha=0.1) +
  geom_point(data = MABGBgrid, aes(x = Lon, y = Lat), size=0.05, colour = "green",  alpha=0.1) +
  geom_point(data = statewatersgrid, aes(x = Lon, y = Lat), size=0.03, colour = "purple",  alpha=0.5) +
  #coord_sf(xlim = c(-79, -65.5), ylim = c(33, 45)) +
  coord_sf(xlim =c(-78, -65.5), ylim = c(35, 45)) +
  ggtitle("State waters (purple), concentrated bluefish recreational fishing")

```

Indices for aggregate small pelagics from piscivore stomachs can be calculated for any subset of the full model domain. Bias correction of the resulting indices is then applied `r Cite(myBib, "thorson_implementing_2016")`. 

???
NEFSC survey strata definitions are built into the VAST `northwest-atlantic` extrapolation grid already. We defined additional new strata to address the recreational inshore-offshore 3 mile boundary. The area within and outside 3 miles of shore was defined using the `sf` R package as a 3 nautical mile (approximated as 5.556 km) buffer from a high resolution coastline from the`rnaturalearth` R package. This buffer was then intersected with the current `FishStatsUtils::northwest_atlantic_grid` built into VAST and saved using code [here](https://github.com/sgaichas/bluefishdiet/blob/main/VASTcovariates_updatedPreds_sst_3mi.Rmd#L49-L94). Then, the new State and Federal waters strata were used to split NEFSC survey strata where applicable, and the new full set of strata were used along with a modified function from `FishStatsUtils::Prepare_NWA_Extrapolation_Data_Fn` to build a custom extrapolation grid for VAST as described in detail [here](https://sgaichas.github.io/bluefishdiet/VASTcovariates_finalmodbiascorrect_3misurvstrat.html). 

---
background-image: url("https://github.com/sgaichas/bluefishdiet/raw/main/pyindex/allagg_fall_500_lennosst_ALLsplit_biascorrect/ln_density-predicted.png")
background-size: 560px
background-position: right top

## Results: Fall Forage Index

```{r}
WHAMinputsviz <- function(infile) {
  
  splitoutput <- read.csv(infile)
  
  # warning, hardcoded. obviously
  stratlook <- data.frame(Stratum = c("Stratum_1",
                                      "Stratum_2",
                                      "Stratum_3",
                                      "Stratum_4",
                                      "Stratum_5",
                                      "Stratum_6",
                                      "Stratum_7",
                                      "Stratum_8",
                                      "Stratum_9",
                                      "Stratum_10",
                                      "Stratum_11",
                                      "Stratum_12",
                                      "Stratum_13",
                                      "Stratum_14",
                                      "Stratum_15"),
                          Region  = c("AllEPU", 
                                      "MABGB", 
                                      "MABGBstate", 
                                      "MABGBfed", 
                                      "MAB",
                                      "GB",
                                      "GOM",
                                      "bfall",
                                      "bfin",
                                      "bfoff",
                                      "MABGBalbinshore",
                                      "MABGBothoffshore",
                                      "albbfin",
                                      "albbfall",
                                      "allother"))
  
    # The palette with grey:
cbPalette <- c("#999999",  "#56B4E9", "#E69F00", "#CC79A7", "#009E73", "#F0E442", "#0072B2", "#D55E00")

  
  forageindex <- splitoutput %>%
    left_join(stratlook) %>%
    dplyr::select(Time, Region, Estimate, SE=Std..Error.for.Estimate) %>%
    tidyr::pivot_longer(c(Estimate, SE), names_to = "Var") %>%
    dplyr::group_by(Var) %>%
    tidyr::pivot_wider(names_from = Region, values_from = value) %>%
    dplyr::mutate(SurvIn2 = bfin,
                  SurvIn2Off = bfall,
                  SurvIn1 = albbfin, 
                  SurvIn1Off = albbfall, 
                  StateWaters = MABGBstate,
                  FedWaters =   MABGBfed) %>%
    dplyr::select(Time, SurvIn2, SurvIn2Off, SurvIn1, SurvIn1Off, StateWaters) %>%
    tidyr::pivot_longer(!c(Time, Var), names_to = "Region", values_to = "value") %>%
    tidyr::pivot_wider(names_from = "Var", values_from = "value")
 
  ggplot(forageindex, aes(x=Time, y=Estimate, colour = Region)) +
    geom_errorbar(aes(ymin=Estimate+SE, ymax=Estimate-SE))+
    geom_point()+
    geom_line() +
    scale_colour_manual(values=cbPalette)
  
} 
```

.pull-left[
```{r WHAMfall, fig.cap="Time series of VAST estimated fall forage indices for input into the bluefish assessment, 1985-2021", fig.asp=0.8}
WHAMinputsviz(infile = url("https://raw.githubusercontent.com/sgaichas/bluefishdiet/main/pyindex/allagg_fall_500_lennosst_ALLsplit_biascorrect/Index.csv"))
```

VAST estimated Fall forage biomass density &rarr;
]

.pull-right[
]
???

---
## Ecosystem reporting: Can forage indices link zooplankton and fish productivity?

.pull-left[

```{r ecodata}
#fishcond <- magick::image_read("https://github.com/NOAA-EDAB/presentations/raw/master/docs/EDAB_images/MAB_Condition_allsex_2022_viridis.jpg") 
#magick::image_trim(fishcond)

epu_abbr = "MAB"

```

```{r, code=readLines("https://raw.githubusercontent.com/NOAA-EDAB/ecodata/master/chunk-scripts/macrofauna_MAB.Rmd-productivity-anomaly.R"), fig.asp=.6}

```

.left[
```{r, code=readLines("https://raw.githubusercontent.com/NOAA-EDAB/ecodata/master/chunk-scripts/LTL_MAB.Rmd-zoo-abund.R"), out.width = "90%", fig.asp=.5}

```
]
]

.pull-right[

```{r SOEforage, fig.cap="Time series of VAST estimated fall forage indices for the 2023 State of the Ecosystem report", fig.asp=1}

splitoutput <- read.csv(url("https://raw.githubusercontent.com/sgaichas/bluefishdiet/main/pyindex/allagg_fall_500_lennosst_ALLsplit_biascorrect/Index.csv"))

# warning, hardcoded. obviously
  stratlook <- data.frame(Stratum = c("Stratum_1",
                                      "Stratum_2",
                                      "Stratum_3",
                                      "Stratum_4",
                                      "Stratum_5",
                                      "Stratum_6",
                                      "Stratum_7",
                                      "Stratum_8",
                                      "Stratum_9",
                                      "Stratum_10",
                                      "Stratum_11",
                                      "Stratum_12",
                                      "Stratum_13",
                                      "Stratum_14",
                                      "Stratum_15"),
                          Region  = c("AllEPU", 
                                      "MABGB", 
                                      "MABGBstate", 
                                      "MABGBfed", 
                                      "MAB",
                                      "GB",
                                      "GOM",
                                      "bfall",
                                      "bfin",
                                      "bfoff",
                                      "MABGBalbinshore",
                                      "MABGBothoffshore",
                                      "albbfin",
                                      "albbfall",
                                      "allother"))

forageindexSOE <- splitoutput %>%
    left_join(stratlook) %>%
    dplyr::select(Time, Region, Estimate, SE=Std..Error.for.Estimate) %>%
    tidyr::pivot_longer(c(Estimate, SE), names_to = "Var") %>%
    dplyr::group_by(Var) %>%
    tidyr::pivot_wider(names_from = Region, values_from = value) %>%
    dplyr::select(Time, MAB, GB, GOM) %>%
    tidyr::pivot_longer(!c(Time, Var), names_to = "Region", values_to = "value") %>%
    dplyr::mutate(Region = factor(Region, levels = c("GOM", "GB", "MAB"))) %>%
    tidyr::pivot_wider(names_from = "Var", values_from = "value")
 
  ggplot(forageindexSOE, aes(x=Time, y=Estimate, colour = Region)) +
    geom_errorbar(aes(ymin=Estimate+SE, ymax=Estimate-SE))+
    geom_point()+
    geom_line() + 
    scale_y_continuous(limits = c(0,NA)) +
    facet_wrap(~Region, scales = "free_y", nrow = 3)
```

]

???
aggregate forage important in this system with many forage species: Jason Link horrendogram

potential trends in aggregate forage to be compared with trends in zooplankton and environmental drivers
---
## What have we learned? New England Atlantic Herring as forage `r Cite(myBib,"deroba_dream_2018")`.
.pull-left-30[
Complex food web, generalist predators
- Weak individual predator response to many herring harvest control rules
- (Stronger predator response to changing herring growth)
- Herring is one of several important prey (36-40 in plot)
- Assessing multiple prey together will likely show stronger effects on predators
]
.pull-right-70[
![NEUSfw](https://github.com/NOAA-EDAB/presentations/raw/master/docs/EDAB_images/LinkNEUSfoodweb.png)
.contrib[The original "horrendogram" `r Cite(myBib,"link_does_2002")`]
]

---
## Do prey affect bluefish availability? Depends on the index. *Preliminary results...Review in December*

.pull-left[
A new bluefish stock assessment was implemented using the Woods Hole Assessment Model (WHAM) `r Cite(myBib,"stock_woods_2021")`.

Forage fish indices were explored as covariates on catchability for the fishery independent bottom trawl surveys, but either did not improve the assessment, or the exploratory models did not converge.

However, the application of the forage fish index to the recreational catch per angler catchability was successful when implemented as an autoregressive process over the time-series with WHAM estimating the standard error.  **The inclusion of the forage fish index improved the fit of all models.**
]

.pull-right[
![:img preliminary results of including the forage fish index within the bluefish assessment comparing fishing mortality, recruitment, and spawning stock biomass time series between models with (purple, blue) and without (green, yellow) the index](https://github.com/NOAA-EDAB/presentations/raw/master/docs/EDAB_images/BluefishWHAMecovPRELIM.png)
]

The use of the forage fish index as a covariate on catchability led to an overall decreasing trend in catchability over time.  The recreational index is important in scaling the biomass results, and the lower availability at the end of the time-series led to <span style="color:#5D3FD3;">higher biomass estimates from the assessment including forage fish.</span>  



???
WHAM is a state space stock assessment model framework: https://timjmiller.github.io/wham/

The Bigelow index fit with the fall forage fish index did not improve the model fit (AIC), was slightly worse fit and gave identical results
The Albatross index fit with the fall forage fish index did not converge or hessian was not positive definite for any of the models (even when how = 0 for some of them).
The MRIP index fit with the annual forage fish index did not converge or hessian was not positive definite for any of the models


---
## Thank you!  References

.contrib[
```{r refs, echo=FALSE, results="asis"}
PrintBibliography(myBib)
```
]

## Additional resources

.contrib[
[Northeast US State of the Ecosystem Reports](https://www.fisheries.noaa.gov/new-england-mid-atlantic/ecosystems/state-ecosystem-reports-northeast-us-shelf)
]

.footnote[
Slides available at https://noaa-edab.github.io/presentations  
Contact: <Sarah.Gaichas@noaa.gov>
]
