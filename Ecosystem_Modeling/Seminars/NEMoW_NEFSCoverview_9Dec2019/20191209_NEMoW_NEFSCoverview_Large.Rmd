---
title: "Progress in ecosystem modeling <br />for resource management: NEFSC"
subtitle: "NEMoW 5, ToR 1"
author: "Scott Large <br /> Northeast Fisheries Science Center <br /> Contributors: Andy Beet, Joe Caracappa, Kiersten Curti, Gavin Fay (UMass Dartmouth), Michael Fogarty, Sarah Gaichas, Robert Gamble, Sean Lucey, Tim Miller, Ryan Morse, Laurel Smith, Brian Stock, Vanessa Trijoulet (DTU Aqua)"
output:
  xaringan::moon_reader:
    css: ["default", "libs/EDAB_theme2.css"]
    lib_dir: libs
    nature:
      titleSlideClass: ["right", "middle", "my-title"]
      highlightStyle: githubp
      highlightLines: true
      countIncrementalSlides: false
  revealjs::revealjs_presentation:
    self_contained: false
    reveal_plugins: ["notes", "search"]
---
class: top, left

```{r setup, include=FALSE}

options(htmltools.dir.version = FALSE)
knitr::opts_chunk$set(echo = F,
                      warning = F,
                      message = F)
#Plotting and data libraries
library(ggplot2)
library(dplyr)
library(tidyr)
library(here)
library(kableExtra)
library(ggrepel)
library(stringr)
library(patchwork)
library(grid)
library(plotly)
library(vegan)
library(rpart)
library(colorRamps)
library(ecodata)

#GIS libraries
library(sf)
library(rgdal)
#library(raster)
library(rnaturalearth)

data.dir <- here::here("data")

#herring MSE outputs
allres <- readRDS(file.path(data.dir,"allres.rds"))

#herring MSE plotting
#a better plotting theme than ggplot default? from https://rpubs.com/Koundy/71792
theme_Publication <- function(base_size=14, base_family="") {
      library(grid)
      library(ggthemes)
      (theme_foundation(base_size=base_size, base_family=base_family)
       + theme(plot.title = element_text(face = "bold",
                                         size = rel(1.2), hjust = 0.5),
               text = element_text(),
               panel.background = element_rect(colour = NA),
               plot.background = element_rect(colour = NA),
               panel.border = element_rect(colour = NA),
               axis.title = element_text(face = "bold",size = rel(1)),
               axis.title.y = element_text(angle=90,vjust =2),
               axis.title.x = element_text(vjust = -0.2),
               axis.text = element_text(), 
               axis.line = element_line(colour="black"),
               axis.ticks = element_line(),
               panel.grid.major = element_line(colour="#f0f0f0"),
               panel.grid.minor = element_blank(),
               legend.key = element_rect(colour = NA),
               legend.position = "right",
               legend.direction = "vertical",
               legend.key.size= unit(0.4, "cm"),
               legend.margin = unit(0, "cm"),
               legend.title = element_text(face="italic"),
               plot.margin=unit(c(10,5,5,5),"mm"),
               strip.background=element_rect(colour="#f0f0f0",fill="#f0f0f0"),
               strip.text = element_text(face="bold")
          ))
      
}

scale_fill_Publication <- function(...){
      library(scales)
      discrete_scale("fill","Publication",manual_pal(values = c("#386cb0","#fdb462","#7fc97f","#ef3b2c","#662506","#a6cee3","#fb9a99","#984ea3","#ffff33")), ...)

}

scale_colour_Publication <- function(...){
      library(scales)
      discrete_scale("colour","Publication",manual_pal(values = c("#386cb0","#fdb462","#7fc97f","#ef3b2c","#662506","#a6cee3","#fb9a99","#984ea3","#ffff33")), ...)

}




#Time series constants
shade.alpha <- 0.3
shade.fill <- "lightgrey"
lwd <- 1
pcex <- 2
trend.alpha <- 0.5
trend.size <- 2
hline.size <- 1
hline.alpha <- 0.35
hline.lty <- "dashed"
label.size <- 5
hjust.label <- 1.5
letter_size <- 4
feeding.guilds <- c("Apex Predator","Piscivore","Planktivore","Benthivore","Benthos")
x.shade.min <- 2009
x.shade.max <- 2018
map.lwd <- 0.4
#Function for custom ggplot facet labels
label <- function(variable,value){
  return(facet_names[value])
}

#facet names for titles
facet_names <- list("Apex predators" = expression("Apex predators"),
                    "Piscivores" = expression("Piscivores"),
                    "Planktivores" = expression("Planktivores"),
                    "Benthivores" = expression("Benthivores"),
                    "Benthos" = expression("Benthos"))
#CRS
crs <- "+proj=longlat +lat_1=35 +lat_2=45 +lat_0=40 +lon_0=-77 +x_0=0 +y_0=0 +datum=NAD83 +no_defs +ellps=GRS80 +towgs84=0,0,0"

#Coastline shapefile
coast <- ne_countries(scale = 10,
                          continent = "North America",
                          returnclass = "sf") %>%
             sf::st_transform(crs = crs)

#State polygons
ne_states <- ne_states(country = "united states of america",
                                      returnclass = "sf") %>%
  sf::st_transform(crs = crs)

#high-res polygon of Maine
#new_england <- read_sf(gis.dir,"new_england")

#EPU shapefile
epu_sf <- ecodata::epu_sf %>% 
  filter(EPU %in% c("MAB","GB","GOM"))


```

## This is the update!

.pull-left[
*Review of Ecosystem Modeling Progress*
- Management Products

- Important Research Results

- Tools Available 

- Tools in Develpment

]
.pull-right[
*Best Practices Improving Model Utility for Management*
- Ecosystem Model Reviews

- Science-Management Collaborations

- Open Science Workflows


]


???
---
## Review: Management Products
*Atlantic herring harvest control rule selected based on multispecies MSE*
.pull-left[
Models quantitatively linked to stakeholder-selected performance metrics, management objectives

```{r OMdesign, echo = F, fig.align = "center", out.width="95%"}
knitr::include_graphics("EDAB_images/OMdesign.png")
```
]
.pull-right[
Multiple options to meet criteria
.contrib[
- Tern productivity at 1.0 or above > 90% of the time
- Herring biomass > 90% of SSBmsy
- Fishery yield > 90% of MSY
- AND fishery closures (F=0) < 1% of the time.
]
```{r}
Nrulesgoodterns <- allres %>%
  filter(CR %in% c("BB", "BB3yr")) %>%
  group_by(OM,CR)%>%
  filter(MedPropYrs_goodProd_Targplustern>0.9) %>%
  summarize(tern90 = n())

Nrulesgoodfishery <- allres %>%
  filter(CR %in% c("BB", "BB3yr")) %>%
  group_by(OM,CR)%>%
  filter(YieldrelMSY>0.9) %>%
  summarize(yield90 = n())

Nrulesgoodherring <- allres %>%
  filter(CR %in% c("BB", "BB3yr")) %>%
  group_by(OM,CR)%>%
  filter(MedSSBrelSSBmsy>0.9) %>%
  summarize(SSB90 = n())

Nrulesgoodternherrfish <- allres %>%
  filter(CR %in% c("BB", "BB3yr")) %>%
  filter(MedPropYrs_goodProd_Targplustern>0.9 & MedSSBrelSSBmsy>0.9 & YieldrelMSY>0.9 & PropClosure < 0.01) %>%
  group_by(OM,CR)%>%
  summarize(ternfishherr90 = n(), 
            minF = min(FracFtarg), 
            maxF = max(FracFtarg),
            minloB = min(FracBmsyThreshLo), 
            maxloB = max(FracBmsyThreshLo),
            minhiB = min(FracBmsyThreshHi),
            maxhiB = max(FracBmsyThreshHi)
  )

CRsgoodternherrfish <- allres %>%
  filter(CR %in% c("BB", "BB3yr")) %>%
  filter(MedPropYrs_goodProd_Targplustern > 0.9 & MedSSBrelSSBmsy > 0.9 & YieldrelMSY > 0.9 & PropClosure < 0.01) %>%
  group_by(OM,CR) %>%
  select(OM, CR, FracBmsyThreshLo, FracBmsyThreshHi,FracFtarg) %>%
  mutate(id = seq(1:n()),
         Xmin = 0,
         Xmax = 4) %>%
  gather(CRpart, x, Xmin,FracBmsyThreshLo, FracBmsyThreshHi,Xmax) %>%
  arrange(OM, CR, id) %>%
  mutate(y = case_when(CRpart == "Xmin" | CRpart == "FracBmsyThreshLo" ~ 0,
                       CRpart == "FracBmsyThreshHi" | CRpart == "Xmax" ~ FracFtarg)) %>%
  mutate(bigkey = paste0(OM, CR, id))
  
#with(CRsgoodternherrfish, 
#     plot(x=c(0,FracBmsyThreshLo, FracBmsyThreshHi, 4),
#          y=c(0,0,FracFtarg, FracFtarg), type="l"))  
  
p1 <- ggplot(CRsgoodternherrfish, aes(x=x, y=y, colour=CR)) + 
  geom_line(aes(group=bigkey), alpha=0.3) +
  labs(y="F/Fmsy", x="SSB/SSBmsy", colour="Control rule type") +
  guides(colour = guide_legend(override.aes = list(alpha = 1))) +
  theme_Publication() + scale_colour_Publication()

OMlabels <- c(HiM_LowSteep_AssBias_OldWt = 'LowFastBiased', 
              HiM_LowSteep_AssBias_RecWt = 'LowSlowBiased', 
              HiM_LowSteep_NoAssBias_OldWt = 'LowFastCorrect', 
              HiM_LowSteep_NoAssBias_RecWt = 'LowSlowCorrect',  
              LoM_HiSteep_AssBias_OldWt =  'HighFastBiased',  
              LoM_HiSteep_AssBias_RecWt = 'HighSlowBiased', 
              LoM_HiSteep_NoAssBias_OldWt = 'HighFastCorrect',
              LoM_HiSteep_NoAssBias_RecWt = 'HighSlowCorrect'
              )

p1 + facet_wrap("OM", labeller=labeller(OM = OMlabels), nrow=2) + theme(legend.position="bottom")

```
]
.footnote[
Deroba, J. J., Gaichas, S. K., Lee, M.-Y., Feeney, R. G., Boelke, D. V., and Irwin, B. J. (2018). The dream and the reality: meeting decision-making time frames while incorporating ecosystem and economic models into management strategy evaluation. Can. J. Fish. Aquat. Sci. doi:10.1139/cjfas-2018-0128.
]
???
Herring were linked to 3 sensitive predator types with adequate data to justify modeling; no exisitng model addressed all objectives and analytical time was limited to <1 year.
Three control rule types--Constant catch, conditional constant catch, and 15% restriction on change--were rejected at the second stakeholder meeting for poor fishery and predator performance.
Supplemental food web modeling showed tradeoffs between forage groups 
---
## Review: Management Products
*Mid-Atlantic EAFM Policy Guidance, risk assessment, conceptual modeling*
.pull-left[
.contrib[Mid-Atlantic EAFM framework:]

```{r framework, echo = F, out.width = "90%", fig.align = "center"}
knitr::include_graphics("EDAB_images/Framework.png")
```

Details on development, including workshop presentations and white papers:
http://www.mafmc.org/eafm
]

.pull-right[
.contrib[Species, Ecosystem, and Sector level risk elements:]
```{r sptable, fig.align="center",out.width="85%"}
knitr::include_graphics("EDAB_images/sptable2019.png")
```

```{r ecotable, fig.align="center",out.width="85%"}
knitr::include_graphics("EDAB_images/ecotable2019.png")
```

```{r mgttable, fig.align="center",out.width="85%"}
knitr::include_graphics("EDAB_images/mgttable2019.png")
```

]
.footnote[
Gaichas, S., Seagraves, R., Coakley, J., DePiper, G., Guida, V., Hare, J., et al. (2016). A Framework for Incorporating Species, Fleet, Habitat, and Climate Interactions into Fishery Management. Frontiers in Marine Science 3. doi:10.3389/fmars.2016.00105.  
Gaichas, S. K., DePiper, G. S., Seagraves, R. J., Muffley, B. W., Sabo, M., Colburn, L. L., et al. (2018). Implementing Ecosystem Approaches to Fishery Management: Risk Assessment in the US Mid-Atlantic. Front. Mar. Sci. 5. doi:10.3389/fmars.2018.00442.
]

???
* Working group of habitat, biology, stock assessment, management, economic and social scientists developed:

  * draft conceptual models of high risk elements, linkages
  * dataset identification and gap analysis for each element and link
  * draft questions that the Council could persue with additional work
]  
* Final conceptual model and supporting information at December 2019 Council meeting

* Council may then elect to proceed with management strategy evaluation (MSE) using the information from conceptual modeling as a basis

---
```{r sfconceptmod, echo = F, fig.align = "center"}
# setup for conceptual model
PKG <- c(#"foreign","foodweb","sna", "DiagrammeR","circlize", "kableExtra", "googledrive", "readxl"
         "RColorBrewer","QPress",
         "chorddiag")

for (p in PKG) {
  if(!require(p,character.only = TRUE)) {
    install.packages(p)
    require(p,character.only = TRUE)}
}


#assumes this is a project and .dia file is in data directory
edges <- model.dia(file.path(data.dir, "Summer_Flounder_July22_2019.dia"))

source("R/interactive_chord_sfconsmod.R")

interactive_chord_sfconsmod(edges, width=710, height=710, margin=130)

```

???
trying to ge the tooltip part working but may not by next week; xaringan doesnt handle htmlwidgets the same as pure html!
---
## Review: Important Research Results
*Ignore predation at your peril: results from multispecies state-space modeling*  
>Ignoring trophic interactions that occur in marine ecosystems induces bias in stock assessment outputs and results in low model predictive ability with subsequently biased reference points.  

.pull-left-40[
![VanessaPaper](EDAB_images/VanessaPaper.png)
.contrib[
EM1: multispecies state space 

EM2: multispecies, no process error 

EM3: single species state space, constant M 

EM4: single species state space, age-varying M 

*note difference in scale of bias for single species!*
]

]
.pull-right-60[
![modcomp](EDAB_images/jpe13515-fig-0004-m.jpg)
]
.footnote[
Trijoulet, V., Fay, G., and Miller, T. J. (2019) Performance of a state-space multispecies model: What are the consequences of ignoring predation and process errors in stock assessments? Journal of Applied Ecology n/a. doi:10.1111/1365-2664.13515.

Trijoulet, V., Fay, G., Curti, K. L., Smith, B., and Miller, T. J. (2019) Performance of multispecies assessment models: insights on the influence of diet data. ICES J Mar Sci. doi:10.1093/icesjms/fsz053.

]

???
This is an important paper both because it demonstrates the importance of addressing strong species interactions, and it shows that measures of fit do not indicate good model predictive performance. Ignoring process error caused bias, but much smaller than ignoring species interactions.
See also Vanessa's earlier paper evaluating diet data interactions with multispecies models
---
## Review: Important Research Results
Climate-condition links from Laurel

---
## Review: Tools Available 

See tool demonstrations for more info on:
* [Rpath](https://github.com/NOAA-EDAB/Rpath) 
  - static and dynamic food web model framework in R, MSE capability
  - collaboration with Alaska Center
* [atlantisom](https://github.com/r4atlantis/atlantisom) 
  - generate datasets from Atlantis for model performance testing
  - collaboration with Northwest Center, S&T, UMass, and others
* [WHAM](https://github.com/timjmiller/wham) 
  - state space model incorporating environmental data


Hydra and all other models on github--links


---
## Review: Tools in Development
*Addressing needs in Northeast Regional Climate Action Plan*
Atlantis update (hydro, groups, etc)

Automated evaluation of Atlantis model using review criteria from Kaplan et al and other atlantis Pethybridge et al 

Atlantis climate hindcasts and forecasts

---
## Best Practices: Ecosystem Model Reviews
CIE for Ecosystem Based Fishery Management Strategy 
add things that have been done since then, visualizations for stakeholders  

ICES WGSAM model review process 2019


---
## Best Practices: Science-Management collaborations
ICES WGNARS  
NEFMC EBFM PDT and MSE SC   
MAFMC EAFM process  
SOE workshops? And any other stakeholder processes  
CAUSES  


---
## Best Practices: Open Science Workflows
*Improvements to reproducibility and provenance*
.contrib[
* Most developed for indicator reporting; [mscatch](https://github.com/NOAA-EDAB/mscatch) standardizing data inputs across models
* Managers appreciate concise reports, but back-end critical for describing collection, analyses, and processing
* Streamlined workflow allowed scientists to meet management deadlines

]  
![soe-data-flow](EDAB_images/soe-data-flow.png)  


---
## If you want **all** the details

* [New England Atlantic herring management](https://www.nefmc.org/management-plans/herring)
* [New England herring MSE stakeholder process paper](https://www.nrcresearchpress.com/doi/abs/10.1139/cjfas-2018-0125#.XTb_v5NKgWo)
* [New England herring MSE modeling paper](https://www.nrcresearchpress.com/doi/10.1139/cjfas-2018-0128#.XTb_c5NKgWo)

* [Mid-Atlantic EAFM paper](https://www.frontiersin.org/articles/10.3389/fmars.2016.00105/full)
* [Mid-Atlantic Risk Assessment paper](https://www.frontiersin.org/articles/10.3389/fmars.2016.00105/full)
* [Mid-Atlantic Summer Flounder conceptual model and support tables](https://gdepiper.github.io/Summer_Flounder_Conceptual_Models/sfconsmod_riskfactors_subplots.html)
* [2019 Mid-Atlantic State of the Ecosystem report](http://www.mafmc.org/s/SOE-MAFMC-2019.pdf)

* [State of the Ecosystem Technical Documentation](https://noaa-edab.github.io/tech-doc)
* [ecodata R package](https://github.com/noaa-edab/ecodata)
  * [Macrofauna indicators](http://noaa-edab.github.io/ecodata/macrofauna)
  * [Human Dimensions indicators](http://noaa-edab.github.io/ecodata/human_dimensions)
  * [Lower trophic level indicators](http://noaa-edab.github.io/ecodata/LTL)


* Slides available at https://noaa-edab.github.io/presentations


---
# Extra Slides

---
## Standardized indicator visualization in reports

Status (short-term) and trend (long-term) of components are measured as **indicators** and plotted in a standardized way

Indicators are selected to

1. Be broadly informative about a component in a management context<sup>1-3</sup>

1. Minimize redundancy of information

1. Be responsive to ecosystem change


```{r doc-orientation, echo = F, warning = F, message=F, fig.height = 3, fig.width=8, fig.align = "center"}
m <- 0.1
x <- 1989:2018
y <-  m*x + rnorm(30, sd = 0.35)

data <- data.frame(x = x,
                  y = y)

#Define constants for figure plot
x.shade.max <- max(x)
x.shade.min <- x.shade.max - 9 
hline = mean(y)

#Plot series with trend 
ggplot2::ggplot(data = data,aes(x = x, y = y)) +
  #Highlight last ten years
  annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  geom_point(size = pcex) +
  scale_color_manual(aesthetics = "color")+
  guides(color = FALSE) +
  geom_hline(aes(yintercept = hline),
              size = hline.size,
             alpha = hline.alpha,
             linetype = hline.lty)+
  geom_line() +
  geom_gls() +
  scale_y_continuous(labels = function(l){trans = l / 1000})+
  scale_x_continuous(breaks = seq(1985, 2015, by = 5), expand = c(0.01, 0.01)) +
  ylab(expression("Invented Index, 10"^3*"widgets")) +
  xlab("Year") +
  ggtitle("Indicator Z") +
  theme_ts() +
  theme(plot.title = element_text(size = 16),
        axis.title = element_text(size = 14))
```



.footnote[
[1] Rice J. C.Rochet M. J. "A framework for selecting a suite of indicators for fisheries management." ICES Journal of Marine Science 62 (2005): 516â€“527.

[2] Link J. 2010. Ecosystem-Based Fisheries Management: Confronting Tradeoffs . Cambridge University Press, New York.

[3] Zador, Stephani G., et al. "Ecosystem considerations in Alaska: the value of qualitative assessments." ICES Journal of Marine Science 74.1 (2017): 421-430.
]

---
## Risk assessent indicators and ranking criteria: System productivity

This element is applied at the ecosystem level, and ranks the risk of not achieving optimum yield due to changes in ecosystem productivity at the base of the food web.

Four indicators are used together to assess risk of changing ecosystem productivity: primary production, zooplankton abundance, fish condition and fish recruitment. 

.table[
```{r riskecop, echo=FALSE, message=FALSE, warnings=FALSE, results='asis'}
tabl <- "
| Risk Level         | Definition                                                          |  
|:-------------------|:--------------------------------------------------------------------|
| Low  | No trends in ecosystem productivity |
| Low-Moderate | Trend in ecosystem productivity (1-2 measures, increase or decrease) |
| Moderate-High | Trend in ecosystem productivity (3+ measures, increase or decrease) |
| High | Decreasing trend in ecosystem productivity, all measures |
"
cat(tabl) # output the table in a format good for HTML/PDF/docx conversion
```
]
???
We examine trends in total primary production, zooplankton abundance for a key Mid-Atlantic species, and two aggregate fish productivity measures: condition factor (weight divided by length of individual fish) and a survey based "recruitment" (small fish to large fish) index.

---
## Risk assessent indicators and ranking criteria: System productivity
.pull-left[
```{r pp-trends, fig.height=4}
out_pp <- ecodata::chl_pp %>% 
  filter(EPU %in% c("MAB", "GOM","GB"),
         str_detect(Var, "MONTHLY_PPD_MEDIAN")) %>% 
  separate(.,Time, into = c("Year","Month"), sep = 4) %>% 
    mutate(Month = plyr::mapvalues(Month, from = c("01","02","03","04","05","06",
                                                   "07","08","09","10","11","12"),
                                   to = c(month.abb))) %>% 
  group_by(EPU, Month) %>% 
  mutate(hline = mean(Value))
out_pp$Month <- factor(out_pp$Month, levels = month.abb)

 
 pp_cci_mab <-out_pp %>% 
  filter(EPU == "MAB") %>% 
 ggplot() +
   # geom_gls(aes(x = Year, y = Value, group = Month))+
    geom_point(aes(x = Year, y = Value, group = Month)) +
    geom_line(aes(x = Year, y = Value, group = Month)) +
    scale_x_discrete(name = "Time", breaks = seq(min(out_pp$Year),max(out_pp$Year),10)) +  
    facet_wrap(Month~., ncol = 6) +
    ggtitle("MAB Monthly median PPD") +
    ylab(expression("PP (gC m"^-2*" d"^-1*")")) +
        geom_hline(aes(yintercept = hline,
                     group = Month),
           size = hline.size,
           alpha = hline.alpha,
           linetype = hline.lty)+
    theme_facet() +
    theme(axis.text.x = element_text(angle=45, hjust = 1),
          panel.spacing = unit(1, "lines"),
          plot.margin = unit(c(0.1, 0, 0, 0), "cm"))
 
 pp_cci_mab 
 
```

```{r fish-con2, fig.align="center"}
knitr::include_graphics("EDAB_images/MAFMC_Fish_Condition_2019.jpg")
```
]

.pull-right[
```{r seasonal-zoo, fig.height=4}
facet_names <- list(
  'centropages spring'=expression(paste(italic("Centropages "), "spring")),
  'centropages fall'=expression(paste(italic("Centropages "), "fall")),
  'temora spring'=expression(paste(italic("Temora "), "spring")),
  'temora fall' = expression(paste(italic("Temora "), "fall")),
  'pseudocalanus spring'=expression(paste(italic("Pseudocalanus "), "spring")),
  'pseudocalanus fall' = expression(paste(italic("Pseudocalanus "), "fall")))

zoo_oi_mab <- ecodata::zoo_oi %>% 
  filter(!str_detect(Var,"SD"),
         EPU == "MAB") %>% 
  
  mutate(Var = str_remove(Var, " zoo"),
         Val2 = exp(Value)) %>% 
      group_by(Var) %>% 
  mutate(hline = mean(Val2, na.rm = T)) %>% 
  separate(.,col = Var, into = c("Species","Season"), remove = F)



top <- zoo_oi_mab %>%  
  filter(Species == "centropages") %>% 

ggplot(aes(x = Time, y = Val2, group = Var)) +
  annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = 0, ymax = Inf) +
  geom_hline(aes(yintercept = hline),
     size = hline.size,
     alpha = hline.alpha,
     linetype = hline.lty)+
  geom_gls() +
  geom_line()+
  geom_point()+
  ylab("") +
  facet_wrap(Var ~ ., ncol = 2, scales='free_x',labeller = label) +
  ggtitle("Zooplankton abundance (OI)") +
  scale_x_continuous(expand = c(0.01, 0.01))+
  scale_y_continuous(trans = "log10")+
  theme_facet() +
    theme(strip.text=element_text(hjust=0,
                                face = "italic"),
          axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())

middle <- zoo_oi_mab %>%  
  filter(Species == "pseudocalanus") %>% 
ggplot(aes(x = Time, y = Val2, group = Var)) +
  annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = 0, ymax = Inf) +
  geom_hline(aes(yintercept = hline),
     size = hline.size,
     alpha = hline.alpha,
     linetype = hline.lty)+
  geom_gls() +
  geom_line()+
  geom_point()+
  ylab(expression("Abundance num m"^-3*"")) +
  facet_wrap(Var ~ ., ncol = 2, scales='free_x',labeller = label) +
  scale_x_continuous(expand = c(0.01, 0.01))+
  scale_y_continuous(trans = "log10")+
  theme_facet() +
    theme(strip.text=element_text(hjust=0,
                                face = "italic"),
          axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())

bottom <- zoo_oi_mab %>%  
  filter(Species == "temora") %>% 
ggplot(aes(x = Time, y = Val2, group = Var)) +
  annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = 0, ymax = Inf) +
  geom_hline(aes(yintercept = hline),
     size = hline.size,
     alpha = hline.alpha,
     linetype = hline.lty)+
    geom_gls() +
  geom_line()+
  geom_point()+
    ylab("") +
  facet_wrap(Var ~ ., ncol = 2,labeller = label) +
  scale_x_continuous(breaks = seq(1980,2010,10),
                     expand = c(0.01, 0.01))+

  theme_facet() +
    theme(strip.text=element_text(hjust=0,
                                face = "italic")) +
   scale_y_log10()

top + middle + bottom + plot_layout(ncol = 1) & theme(plot.margin = margin(0,0,0,0,"cm"))
```


```{r fish-prod , fig.height=4}
source("R/productivity_plots.R")
prod <- productivity_plots()
prod
```
]

Ranked low-moderate risk due to the significant long term trends in zooplankton abundance for major species (top right plot)



