---
title: "Multispecies Operating Models"
subtitle: "ICES WKMSEDEV<br /> 28 September 2023"
author: "Sarah Gaichas, Presenter<br /><br /><br />Contributors: Andy Beet, Joe Caracappa,  Gavin Fay (UMass Dartmouth), Sarah Gaichas, Robert Gamble,<br />Madeleine Guyant (UMass Dartmouth), Jerelle Jesse (GMRI/UMaine), Lisa Kerr (GMRI/UMaine),<br />Emily Liljestrand (UMass/NEFSC), Sean Lucey, Maria Cristina Perez (UMass Dartmouth)"
output:
  xaringan::moon_reader:
    css: ["default", "libs/EDAB_theme3_508_SOE_16by9.css"]
    lib_dir: libs
    nature:
      titleSlideClass: ["right", "middle", "my-title"]
      ratio: "16:9"
      highlightStyle: githubp
      highlightLines: true
      countIncrementalSlides: false
      beforeInit: "libs/macros.js"
  revealjs::revealjs_presentation:
    self_contained: false
    reveal_plugins: ["notes", "search"]

---
class: top, left

```{r setup, include=FALSE}

options(htmltools.dir.version = FALSE)
knitr::opts_chunk$set(echo = F,
                      fig.retina = 3,
                      warning = F,
                      message = F)
#Plotting and data libraries
library(tidyverse)
library(tidyr)
library(here)
```

```{r, load_refs, include=FALSE, cache=FALSE}
library(RefManageR)
BibOptions(check.entries = FALSE,
           bib.style = "authoryear",
           cite.style = "authoryear",
           longnamesfirst = FALSE,
           max.names = 1,
           style = "markdown")
myBib <- ReadBib("./mskeyrun.bib", check = FALSE)

#,
#           hyperlink = FALSE,
#           dashed = FALSE

```

# Multispecies and Ecosystem Operating Models

## Overview

Combining existing tools: Link multispecies model to MSE framework with built in single species assessment tools

Example explanatory materials, including Rshiny for exploring results

Food web model Rpath MSE capabilities

Atlantis potential

---
background-image: url(https://github.com/NOAA-EDAB/presentations/raw/master/docs/EDAB_images/pMSEhydra.png)
background-size: 830px
background-position: right

# [EBFM pMSE](https://d23h0vhsm26o6d.cloudfront.net/pMSE-Final-Report2.pdf) 

.pull-left-30[
## Gavin Fay, Lisa Kerr, Madeleine Guyant, Jerelle Jesse, Emily Liljestrand

Hydra: multispecies operating model conditioned on Georges Bank data within MSE framework as prototype test of EBFM strategies. 

Results: additional flexibility and increased yield possible with EBFM "ceilings and floors" without increased risk to single stocks.
]
.pull-right-70[]

---
# Operating model building blocks

.pull-left[
## Multispecies catch at length Hydra `r Cite(myBib, "gaichas_combining_2017")`

*Hydra-Associated GitHub repositories*
* hydra-sim (Simulation Model Wiki): https://github.com/NOAA-EDAB/hydra_sim/wiki
* hydra-sim (estimation fork): https://github.com/thefaylab/hydra_sim
* hydradata (estimation fork): https://github.com/thefaylab/hydradata
* hydra-diag (diagnostics): https://github.com/thefaylab/hydra_diag
]

.pull-right[
## Groundfish MSE framework `r Cite(myBib, "mazur_consequences_2023")`

*Groundfish MSE repository and branches*
https://github.com/lkerr/groundfish-MSE


]

---
.pull-left[

## Management Alternatives

*  Single-species management, with stock-specific assessments and catch advice.
*  Single-species management, with stock-specific assessments and catch advice and
dynamic reference points.
*  Stock complex management, with stock-complex level assessments and abundance
index thresholds.
*  Stock complex management, with stock-complex level assessments and abundance
index thresholds, with gear-based stock complexes.
*  Stock complex management, with stock-complex level assessments and dynamic
reference points.

]

.pull-right[
## Operating Model Scenarios

]

---
background-image: url(https://github.com/NOAA-EDAB/presentations/raw/master/docs/EDAB_images/Fayetal_pMSEss_alts.png)
background-size: 990px
background-position: center bottom
# Single species management alternatives

---
background-image: url(https://github.com/NOAA-EDAB/presentations/raw/master/docs/EDAB_images/Fayetal_pMSEms_alts.png)
background-size: 990px
background-position: center bottom
# Multispecies management alternatives


---
# Assessments, HCRs, Scenarios

.pull-left[

]

.pull-right[

]

---
# Results


---
# Outreach materials

.pull-left[
## One pagers

]

.pull-right[
## Rshiny

]
  
---
background-image: url("https://github.com/NOAA-EDAB/presentations/raw/master/docs/EDAB_images/Balance_concept.png")
background-size: 700px
background-position: right

# More Potential Ecosystem Operating Models

## Rpath &rarr;

## Atlantis
.pull-left[
![:img NEUSmap, 90%](https://ars.els-cdn.com/content/image/1-s2.0-S030438002200148X-gr1_lrg.jpg)
]

---
# Food web responses to management?

## [Rpath](https://github.com/NOAA-EDAB/Rpath) `r Cite(myBib, "lucey_conducting_2020")` with MSE capability `r Cite(myBib, "lucey_evaluating_2021")`

.pull-left[
![](https://github.com/NOAA-EDAB/presentations/raw/master/docs/EDAB_images/MSE_Rpath_Page_05.png)
]

.pull-right[
![](https://github.com/NOAA-EDAB/presentations/raw/master/docs/EDAB_images/MSE_Rpath_Page_14.png)
]

[Rpath MSE course code](https://github.com/thefaylab/cinar-mse-projects/blob/main/multispecies/RpathOM_HCR_PSPS.md)

---
background-image: url("https://github.com/NOAA-EDAB/presentations/raw/master/docs/EDAB_images/herrup10pann.png")
background-size: 830px
background-position: right bottom

## Herring MSE food web model results: ecosystem tradeoffs

Tradeoffs between forage groups and mixed impacts to predators apparent when multiple species and full predator prey interaction feedbacks can be included

.pull-left-30[
* Rpath Ecosense functions evaluate parameter uncertainty within a scenario

* Now we have MSE closed loop possibilities in Rpath `r Cite(myBib, "lucey_evaluating_2021")`

* Can implement HCRs with predator prey interactions 

]
.pull-right-70[

]


---
background-image: url("https://github.com/NOAA-EDAB/presentations/raw/master/docs/EDAB_images/fwcompresults.png")
background-size: 780px
background-position: right bottom

## Herring MSE food web model results: ecosystem uncertainty?

.pull-left-30[
Compare 10% change (green, same as previous slide gray boxes) with more extreme "herring" biomass:  
* 50% increase from base herring biomass (red)
* 50% decrease from base herring biomass (blue)

More system uncertainty with increased herring biomass?
]

.pull-right-70[

]

---
background-image: url("https://ars.els-cdn.com/content/image/1-s2.0-S030438002200148X-gr3_lrg.jpg")
background-size: 500px
background-position: right

# Atlantis NEUSv2: **major** update

.pull-left[
## Joe Carracappa, Andy Beet, Robert Gamble
*  Forcing with GLORYS12V1 and primary production in the newly calibrated model `r Cite(myBib, "caracappa_northeast_2022")`
*  Running in the cloud via NOAA HPC

## In progress
*  Sensitivity to fishing scenarios
*  Testing ecosystem overfishing indicators for the Northeast US
*  Integrating spatial fleets and ports of origin
*  Climate projections using MOM-6 planned

.footnote[https://github.com/NOAA-EDAB/neus-atlantis]  
]



.pull-right[]

---
## References
.contrib[
```{r refs, echo=FALSE, results="asis"}
PrintBibliography(myBib)
```
]  

## Additional Resources

[EBFM pMSE June 2023 New England Council](https://www.nefmc.org/library/june-2023-ecosystem-based-fishery-management-ebfm-committee)
*  [Presentation](https://d23h0vhsm26o6d.cloudfront.net/2_Draft-final-Prototype-Management-Evaluation-pMSE-simulation-results-and-output-2nd-mailing_2023-07-06-181333_tsor.pdf)
*  [Final Report](https://d23h0vhsm26o6d.cloudfront.net/pMSE-Final-Report2.pdf)
*  [One Page Summaries](https://d23h0vhsm26o6d.cloudfront.net/4b_pMSE-one-page-sumamries_2023-07-06-181512_pgju.pdf)
*  ICES WKMSEDEV sharepoint: Background Documents


.footnote[
Slides available at https://noaa-edab.github.io/presentations  
Contact: <Sarah.Gaichas@noaa.gov>
]

---

.center[
# Extra slides: Model equations

press "p" to see slide comments with even more equations
]

---
background-image: url("https://github.com/NOAA-EDAB/presentations/raw/master/docs/EDAB_images/Balance_concept.png")
background-size: 700px
background-position: right

## Food web: [Rpath](https://github.com/NOAA-EDAB/Rpath) in collaboration with AFSC
.pull-left[ 
Species interactions:
- Full predator-prey: Consumption leads to prey mortality and predator growth
- Static and dynamic model components

Static model: 
For each group, $i$, specify: 

   Biomass $B$ (or Ecotrophic Efficiency $EE$)  
   Population growth rate $\frac{P}{B}$  
   Consumption rate $\frac{Q}{B}$  
   Diet composition $DC$  
   Fishery catch $C$  
   Biomass accumulation $BA$  
   Im/emigration $IM$ and $EM$  
   
Solving for $EE$ (or $B$) for each group:

$$B_i\Big(\frac{P}{B}\Big)_i*EE_i+IM_i+BA_i=\sum_{j}\Big[ B_j\Big (\frac{Q}{B}\Big)_j*DC_{ij}\Big ]+EM_i+C_i$$  
]

.pull-right[

]

???
Predation mortality $$M2_{ij} = \frac{DC_{ij}QB_jB_j}{B_i}$$

Fishing mortality $$F_i = \frac{\sum_{g = 1}^n (C_{ig,land} + C_{ig,disc})}{B_i}$$

Other mortality $$M0_i = PB_i \left( 1 - EE_i \right)$$

---
background-image: url("https://github.com/NOAA-EDAB/presentations/raw/master/docs/EDAB_images/ForagingArena.png")
background-size: 380px
background-position: right

## Food web: [Rpath](https://github.com/NOAA-EDAB/Rpath) in collaboration with AFSC

.pull-left-70[ 
Dynamic model (with MSE capability):

$$\frac{dB_i}{dt} = \left(1 - A_i - U_i \right) \sum_{j} Q \left(B_i, B_j \right) -  \sum_{j} Q \left( B_j, B_i \right) - M0_iB_i  - C_m B_i$$
Consumption: 

$$Q \left( B_i, B_j \right) = Q_{ij}^* \Bigg( \frac{V_{ij} Ypred_j}{V_{ij} - 1 + \left( 1 - S_{ij} \right) Ypred_j + S_{i} \sum_k \left( \alpha_{kj} Ypred_k \right)} \Bigg) \times \\\Bigg( \frac{D_{ij} Yprey_i^{\theta_{ij}}}{D_{ij} - 1 + \big( \left( 1 - H_{ij} \right) Yprey_i + H_{i} \sum_k \left( \beta_{ik} Yprey_k \right) \big)^{\theta_{ij}}} \Bigg)$$  
Where $V_{ij}$ is vulnerability, $D_{ij}$ is “handling time” accounting for predator saturation, and $Y$ is relative biomass which may be modified by a foraging time multiplier $Ftime$,

$$Y[pred|prey]_j =  Ftime_j \frac {B_j}{B_j^*}$$

]

.pull-right-30[

]
???
The parameters $S_{ij}$ and $H_{ij}$ are flags that control whether the predator density dependence $S_{ij}$ or prey density dependence $H_{ij}$ are affected solely by the biomass levels of the particular predator and prey, or whether a suite of other species’ biomasses in similar roles impact the relationship. 

For the default value for $S_{ij}$ of 0 (off), the predator density dependence is only a function of that predator biomass and likewise for prey with the default value of 0 for $H_{ij}$.  

Values greater than 0 allow for a density-dependent effects to be affected by a weighted sum across all species for predators, and for prey.  The weights $\alpha_{kj}$ and $\beta_{kj}$ are normalized such that the sum for each functional response (i.e. $\sum_k\alpha_{kj}$ and $\sum_k\beta_{kj}$ for the functional response between predator *j* and prey *i*) sum to 1.  The weights are calculated from the density-independent search rates for each predator/prey pair, which is equal to $2Q_{ij}^*V_{ij} / (V_{ij} - 1)B_i^*B_j^*$.  


---
## Multispecies catch at length simulation model: [Hydra](https://github.com/NOAA-EDAB/hydra_sim)

Species interactions: 
- Predation: Top down only (predators increase M of prey, predators grow regardless of prey)  

*Based on standard structured stock assessment population dynamics equations, Same MSVPA predation equation as MSCAA (but length based), same dependencies and caveats*
- First, split $M$ for species $i$ size $j$ into components: $$M_{i,j,t} = M1_i + M2_{i,j,t}$$  
- Calculate $M2$ with MSVPA predation equation, which applies a predator consumption:biomass ratio to the suitable prey biomass for that predator. 
- Suitability, $\rho$, of prey species $m$ size $n$ for a given predator species $i$ size $j$ a function of size preference and vulnerability  {0,1}. 
- Food intake $I$ for each predator-at-size is temperature dependent consumption rate times mean stomach content weight. 
- Also sensitive to "other food" $\Omega$.

$$M2_{m,n,t} = \sum_i \sum_j I_{i,j,t} N_{i,j,t} \frac{\rho_{i,j,m,n}}{\sum_a \sum_b \rho_{i,j,a,b} W_{a,b} N_{a,b} + \Omega}$$

???
But:
- Covariates on growth, maturity, recruitment possible; intended for environmental variables
- So could hack in prey-dependent growth but making it dynamic is difficult

We specify 'preferred' predator-prey weight ratio (log scale) $\Psi_j$ and variance in predator size preference $\sigma_j$ to compare with the actual predator-prey weight ratio $(w_n / w_j)$ to get the size preference $\vartheta$. 

$$\vartheta_{n,j} = \frac{1}{(w_n / w_j)\sigma_j \sqrt{2\pi}} e^{-\frac{[log_e(w_n / w_j) - \Psi_j]}{2\sigma_j^2}}$$

Food intake is $$I_{i,j,t} = 24 [\delta_j e^{\omega_i T}]\bar{C}_{i,j,k,t}$$

---
## Next: Multispecies catch at age estimation model: *seeking catchy name* [FIT: MSCAA](https://nmfs-ecosystem-tools.github.io/MSCAA/)

Species interactions: 
- Predation: Top down only (predators increase M of prey, predators grow regardless of prey)

*Based on standard age structured stock assessment population dynamics equations*
- First, split $M$ for species $i$ age $a$ into components: $$M_{i,a,t} = M1_i + M2_{i,a,t}$$  
- Calculate $M2$ with MSVPA predation equation, which applies a predator consumption:biomass ratio to the suitable prey biomass for that predator. 
- Suitability is a function of predator size preference (based on an age-specific predator:prey weight ratio) and prey vulnerability (everything about the prey that isn't size related). 
- Also sensitive to "other food"

$$M2_{i,a,t} = \frac{1}{N_{i,a,t}W_{i,a,t}}\sum_j \sum_b CB_{j,b} B_{j,b,t} \frac{\phi_{i,a,j,b,t}}{\phi_{j,b,t}}$$
???

Size preference is $$g_{i,a,j,b,t}=\exp\bigg[\frac{-1}{2\sigma_{i,j}^2}\bigg(\ln\frac{W_{j,b,t}}{W_{i,a,t}}-\eta_{i,j}\bigg)^2\bigg]$$

Suitability, $\nu$ of prey $i$ to predator $j$:
$$\nu_{i,a,j,b,t}=\rho_{i,j}g_{i,a,j,b,t}$$

Scaled suitability: 
$$\tilde\nu_{i,a,j,b,t}=\frac{\nu_{i,a,j,b,t}}{\sum_i \sum_a \nu_{i,a,j,b,t} + \nu_{other}}$$

Suitable biomass of prey $i$ to predator $j$:
$$\phi_{i,a,j,b,t}=\tilde\nu_{i,a,j,b,t}B_{i,a,t}$$

Available biomass of other food, where $B_other$ is system biomass minus modeled species biomass:
$$\phi_{other}=\tilde\nu_{other}B_{other,t}$$
Total available prey biomass:
$$\phi_{j,b,t}=\phi_{other} + \sum_i \sum_a \phi_{i,a,j,b,t}$$
