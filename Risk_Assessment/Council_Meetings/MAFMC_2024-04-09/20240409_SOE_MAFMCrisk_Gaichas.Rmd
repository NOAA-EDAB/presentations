---
title: "EAFM Risk Assessment<br /> Mid Atlantic 2024"
subtitle: "Slides for Brandon <br />MAFMC <br /> 9 April 2024"
author: "Sarah Gaichas and Geret DePiper, based on 2024 SOE"
output:
  xaringan::moon_reader:
    css: ["default", "libs/EDAB_theme3_508_SOE_16by9.css", "libs/cols.css"]
    lib_dir: libs
    nature:
      titleSlideClass: ["right", "middle", "my-title"]
      ratio: "16:9"
      highlightStyle: githubp
      highlightLines: true
      countIncrementalSlides: false
      beforeInit: ["libs/macros.js", "libs/cols_macro.js"]
  revealjs::revealjs_presentation:
    self_contained: false
    reveal_plugins: ["notes", "search"]

---
class: top, left

<style>
p.caption {
  font-size: 0.6em;
}
</style>

<style>
.reduced_opacity {
  opacity: 0.5;
}
</style>

```{r setup, include=FALSE}

options(htmltools.dir.version = FALSE)
knitr::opts_chunk$set(echo = F,
                      fig.retina = 3,
                      #fig.width = 4,
                      #fig.height = 2,
                      fig.asp = 0.45,
                      warning = F,
                      message = F)
#Plotting and data libraries
library(tidyverse)
library(tidyr)
library(here)
library(kableExtra)
library(ecodata)
library(readxl); library(data.table)
library(DT)
library(widgetframe)
library(patchwork)

# if figure output defaults to docs/imaages/ replace with this before moving to 
# presentations/docs in both the html output (search and replace)
# and folder name
# 20220316_MAFMCSSC_Gaichas_files/figure-html/

```

```{r, load_refs, include=FALSE, cache=FALSE}
library(RefManageR)
BibOptions(check.entries = FALSE,
           bib.style = "authoryear",
           cite.style = "authoryear",
           longnamesfirst = FALSE,
           max.names = 1,
           style = "markdown")
myBib <- ReadBib("./MidSOE.bib", check = FALSE)

#,
#           hyperlink = FALSE,
#           dashed = FALSE

```

## Risk Element Example - Commercial revenue

This element is applied at the ecosystem level. Revenue serves as a proxy for commercial profits.

.pull-left[

```{r riskcomval, echo=FALSE, message=FALSE, warnings=FALSE, results='asis'}
# tabl <- "
# | Risk Level         | Definition                                                          |  
# |:-------------------|:--------------------------------------------------------------------|
# | Low  | No trend and low variability in revenue |
# | Low-Moderate | Increasing or high variability in revenue |
# | Moderate-High | Significant long term revenue decrease |
# | High | Significant recent decrease in revenue |
# "
# cat(tabl) # output the table in a format good for HTML/PDF/docx conversion

tabl <- data.frame("Risk Level" = c("Low", "Low-Moderate", "Moderate-High", "High"),
                   "Definition" = c("No trend and low variability in revenue",
                                    "Increasing or high variability in revenue",
                                    "Significant long term revenue decrease",
                                    "Significant recent decrease in revenue"))

knitr::kable(tabl, format="html",
             col.names = c("Risk Level", "Definition"),
                           booktabs = T) %>%
  #kable_styling(full_width = TRUE) %>%
  column_spec(1, width = "10em")|>
  column_spec(2, width = "30em")%>%
  row_spec(3, bold = T, background = "orange")
```

Ranked moderate-high risk due to the significant long term revenue decrease

]
.pull-right[
```{r, fig.asp = 0.7, results='hide'}
#comm-revenue, fig.width = 4, fig.asp = 0.45, fig.cap = "Total revenue for the region (black) and revenue from MAFMC managed species (red)."
ecodata::plot_comdat(report="MidAtlantic", varName="revenue") + 
  ggplot2::theme(legend.position = "bottom",
                      legend.title = ggplot2::element_blank())
```

]

## Risk element: <span style="background-color:orange;">CommRev</span> 

---
class: center, center

# Ecological Risk Elements


---
class: top, left
## Stock Assessment Performance

This risk element is applied at the species
level, and addresses risk to achieving OY due to scientific uncertainty
based on analytical and data limitations.

.pull-left-70[
.table[
```{r, results='asis'}
  # -----------------------------------------------------------------------
  # *Risk Level*    *Definition*
  # --------------- -------------------------------------------------------
  # Low             Assessment model(s) passed peer review, high data
  #                 quality, small retrospective pattern
  # 
  # Low-Moderate    Assessment passed peer review but some data and/or
  #                 reference points may be lacking
  # 
  # Moderate-High   Assessment passed peer review but with major data
  #                 quality issue or large retrospective pattern
  # 
  # High            Assessment failed peer review or no assessment,
  #                 data-limited tools applied
  # -----------------------------------------------------------------------
tabl <- data.frame("Risk Level" = c("Low", "Low-Moderate", "Moderate-High", "High"),
                   "Definition" = c("Assessment model(s) passed peer review, high data quality, small retrospective pattern",
                                    "Assessment passed peer review but some data and/or reference points may be lacking",
                                    "Assessment passed peer review but with major data quality issue or large retrospective pattern",
                                    "Assessment failed peer review or no assessment, data-limited tools applied"))
knitr::kable(tabl, format="html",
             col.names = c("Risk Level", "Definition"),
                           booktabs = T) %>%
  #kable_styling(full_width = TRUE) %>%
  column_spec(1, width = "10em")|>
  column_spec(2, width = "30em")
```
]
]

.pull-right-30[
```{r}
risk.species<-data.frame(
  Species = c("Ocean Quahog", "Surfclam", "Summer flounder", "Scup", "Black sea bass", "Atl. mackerel", "Chub mackerel", "Butterfish", "Longfin squid", "Shortfin squid", "Golden tilefish", "Blueline tilefish", "Bluefish", "Spiny dogfish", "Monkfish", "Unmanaged forage", "Deepsea corals"),
  Assess  = c("l", "l", "l",  "l", "l", "l", "h", "l", "lm", "h", "l", "h", "l", "l", "h", "na", "na")#,
  # Fstatus = c("l", "l", "h", "l", "l", "l", "lm", "l", "lm", "lm", "l", "h", "l", "h", "lm", "na", "na"),
  # Bstatus = c("l", "l", "lm", "l", "l", "h", "lm", "lm", "lm", "lm", "lm", "mh", "lm", "l", "lm", "na", "na"),
  # #FW1Pred = c("l", "l", "l", "l", "l", "l", "l", "l", "l", "l", "l", "l", "l", "l", "l", "l", "l"),
  # #FW1Prey = c("l", "l", "l", "l", "l", "l", "l", "l", "l", "l", "l", "l", "l", "l", "l", "lm", "l"),
  # PreyA = c("tbd", "tbd", "tbd", "tbd", "tbd", "tbd", "tbd", "tbd", "tbd", "tbd", "tbd", "tbd", "tbd", "tbd", "tbd", "tbd", "tbd"),
  # PredP = c("tbd", "tbd", "tbd", "tbd", "tbd", "tbd", "tbd", "tbd", "tbd", "tbd", "tbd", "tbd", "tbd", "tbd", "tbd", "tbd", "tbd"),
  # FW2Prey = c("l", "l", "l", "l", "l", "l", "l", "l", "lm", "lm", "l", "l", "l", "l", "l", "lm", "l"),
  # Climate = c("h", "mh", "lm", "lm", "mh", "lm", "na", "l", "l", "l", "mh", "mh","l", "l", "l", "na", "na"),
  # DistShift = c("mh", "mh", "mh", "mh", "mh", "mh", "na", "h", "mh", "h", "l", "l", "mh", "h", "mh", "na", "na"),
  # EstHabitat = c("l", "l", "h", "h", "h", "l", "l", "l", "l", "l", "l", "l", "h", "l", "l", "na", "na"),
  # OffHab = c("tbd", "tbd", "tbd", "tbd", "tbd", "tbd", "tbd", "tbd", "tbd", "tbd", "tbd", "tbd", "tbd", "tbd", "tbd", "tbd", "tbd")#,
)


# these elements were removed by the council
#  PopDiv = c("na", "na", "na", "na", "na", "na", "na", "na", "na", "na", "na", "na", "na", "na"),
#  FoodSafe = c(),

# one column test
# risk.species %>%
#   mutate(Fstatus = 
#     cell_spec(Fstatus, format="latex", color = "black", align = "c", background =factor(Fstatus, c("na", "l", "lm", "mh", "h"),c("white", "green", "yellow", "orange", "red")))) %>%
#   kable(risk.species, format="latex", escape = F, booktabs = T, linesep = "")

#convert to longer text for consistency and display in html table
risk.species <- risk.species %>%
     mutate_at(vars(-Species), function(x){
       recode(x,'tbd' = "tbd", 'l'="lowest",'lm'="lowmod",'mh'="modhigh",'h'="highest")}) %>%
     as.data.frame()

#generalize to all
risk.species %>%
  mutate_at(vars(-Species), function(x){ 
    cell_spec(x, format="html", 
              color = factor(x, c("tbd", "na", "lowest", "lowmod", "modhigh", "highest"),c("grey","black", "black", "black", "black", "white")), align = "c", 
              background =factor(x, c("tbd","na", "lowest", "lowmod", "modhigh", "highest"),c("grey","white", "lightgreen", "yellow", "orange", "red")), 
              background_as_tile=F)}) %>%
  kable(format = "html", escape = F, table.attr='class="risktable"') %>%
  kable_styling(font_size = 14) 
#   flextable::flextable()
# 
# # Define colors and ranges
# bg_picker <- scales::col_bin(
#     palette = c("white", "light blue"),
#     domain = c(0, 100), # min and max range can be also set dynamically 
#     bins = c(0, 10, 20)) # as well as the bins
# 
# 
# ftab <- regulartable(SalesData) %>% 
#     bg(j = columns, bg = bg_picker)

```

]
---
.pull-left[
## Fishing Mortality and Stock Biomass Status

These elements are applied at the species level. They indicate the level of risk to achieving OY from either overfishing or stock depletion, respectively.

Indicator: Stock status

```{r ,  fig.asp=0.8}
#code = readLines("https://raw.githubusercontent.com/NOAA-EDAB/ecodata/master/chunk-scripts/human_dimensions_MAB.Rmd-stock-status.R"),
#, fig.width = 7.5, fig.asp = 0.5
#stock-status, fig.cap = paste0("Summary of single species status for ",council_abbr," and jointly federally managed stocks (Goosefish and Spiny dogfish). Stocks in green are below the biomass threshold (overfished), stocks in orange are above the biomass threshold but below the biomass target, and stocks in purple are above the biomass target. Only one stock, Atlantic mackerel, has fishing mortality above the limit (subject to overfishing).")

a <- ecodata::plot_stock_status(report = "MidAtlantic")

a$p + ggplot2::coord_cartesian(xlim=c(0,2), ylim=c(0,2)) +
  ggplot2::annotation_custom(gridExtra::tableGrob(a$unknown,
                             theme = gridExtra::ttheme_default(base_size = 7), 
                             rows=NULL), 
                             xmin=0.8, xmax=1.8, ymin=1.5, ymax=2)

```

]

.pull-right[
.table[
```{r}
tabl <- data.frame("Risk Level" = c("Low", "Low-Moderate", "Moderate-High", "High"),
                   "Definition" = c("F < Fmsy; B > Bmsy",
                                    "Unknown, but weight of evidence indicates low overfishing risk; Bmsy > B > 0.5 Bmsy or weight of evidence indicates low risk",
                                    "Unknown status",
                                    "F > Fmsy; B < 0.5 Bmsy"))
knitr::kable(tabl, format="html",
             col.names = c("Risk Level", "Definitions"),
                           booktabs = T) %>%
  #kable_styling(full_width = TRUE) %>%
  column_spec(1, width = "10em")|>
  column_spec(2, width = "30em")
```
]
<br>
```{r}
risk.species<-data.frame(
  Species = c("Ocean Quahog", "Surfclam", "Summer flounder", "Scup", "Black sea bass", "Atl. mackerel", "Chub mackerel", "Butterfish", "Longfin squid", "Shortfin squid", "Golden tilefish", "Blueline tilefish", "Bluefish", "Spiny dogfish", "Monkfish", "Unmanaged forage", "Deepsea corals"),
  # Assess  = c("l", "l", "l",  "l", "l", "l", "h", "l", "lm", "h", "l", "h", "l", "l", "h", "na", "na"),
  Fstatus = c("l", "l", "h", "l", "l", "l", "lm", "l", "lm", "lm", "l", "h", "l", "h", "lm", "na", "na"),
  Bstatus = c("l", "l", "lm", "l", "l", "h", "lm", "lm", "lm", "lm", "lm", "mh", "lm", "l", "lm", "na", "na")#,
  # #FW1Pred = c("l", "l", "l", "l", "l", "l", "l", "l", "l", "l", "l", "l", "l", "l", "l", "l", "l"),
  # #FW1Prey = c("l", "l", "l", "l", "l", "l", "l", "l", "l", "l", "l", "l", "l", "l", "l", "lm", "l"),
  # PreyA = c("tbd", "tbd", "tbd", "tbd", "tbd", "tbd", "tbd", "tbd", "tbd", "tbd", "tbd", "tbd", "tbd", "tbd", "tbd", "tbd", "tbd"),
  # PredP = c("tbd", "tbd", "tbd", "tbd", "tbd", "tbd", "tbd", "tbd", "tbd", "tbd", "tbd", "tbd", "tbd", "tbd", "tbd", "tbd", "tbd"),
  # FW2Prey = c("l", "l", "l", "l", "l", "l", "l", "l", "lm", "lm", "l", "l", "l", "l", "l", "lm", "l"),
  # Climate = c("h", "mh", "lm", "lm", "mh", "lm", "na", "l", "l", "l", "mh", "mh","l", "l", "l", "na", "na"),
  # DistShift = c("mh", "mh", "mh", "mh", "mh", "mh", "na", "h", "mh", "h", "l", "l", "mh", "h", "mh", "na", "na"),
  # EstHabitat = c("l", "l", "h", "h", "h", "l", "l", "l", "l", "l", "l", "l", "h", "l", "l", "na", "na"),
  # OffHab = c("tbd", "tbd", "tbd", "tbd", "tbd", "tbd", "tbd", "tbd", "tbd", "tbd", "tbd", "tbd", "tbd", "tbd", "tbd", "tbd", "tbd")#,
)


# these elements were removed by the council
#  PopDiv = c("na", "na", "na", "na", "na", "na", "na", "na", "na", "na", "na", "na", "na", "na"),
#  FoodSafe = c(),

# one column test
# risk.species %>%
#   mutate(Fstatus = 
#     cell_spec(Fstatus, format="latex", color = "black", align = "c", background =factor(Fstatus, c("na", "l", "lm", "mh", "h"),c("white", "green", "yellow", "orange", "red")))) %>%
#   kable(risk.species, format="latex", escape = F, booktabs = T, linesep = "")

#convert to longer text for consistency and display in html table
risk.species <- risk.species %>%
     mutate_at(vars(-Species), function(x){
       recode(x,'tbd' = "tbd", 'l'="lowest",'lm'="lowmod",'mh'="modhigh",'h'="highest")}) %>%
     as.data.frame()

#generalize to all
risk.species %>%
  mutate_at(vars(-Species), function(x){ 
    cell_spec(x, format="html", 
              color = factor(x, c("tbd", "na", "lowest", "lowmod", "modhigh", "highest"),c("grey","black", "black", "black", "black", "white")), align = "c", 
              background =factor(x, c("tbd","na", "lowest", "lowmod", "modhigh", "highest"),c("grey","white", "lightgreen", "yellow", "orange", "red")), 
              background_as_tile=F)}) %>%
  kable(format = "html", escape = F, table.attr='class="risktable"') %>%
  kable_styling(font_size = 14) 
#   flextable::flextable()
# 
# # Define colors and ranges
# bg_picker <- scales::col_bin(
#     palette = c("white", "light blue"),
#     domain = c(0, 100), # min and max range can be also set dynamically 
#     bins = c(0, 10, 20)) # as well as the bins
# 
# 
# ftab <- regulartable(SalesData) %>% 
#     bg(j = columns, bg = bg_picker)

```

]

---
## Food Web (1) - Prey Availability

This element will be applied at the species level. This element is one of two
separating food web risks to achieving OY for Council managed species
from two sources. This first element assesses prey availability for each
species, and the second food web risk element assesses predation
pressure on each species (see next element).

.pull-left[
*Potential indicators*
```{r, fig.asp=.4} 
ecodata::plot_forage_index() + ggplot2::coord_cartesian(xlim = c(1983, 2021.5)) + ggplot2::ggtitle("Aggregate forage fish index") 
```

```{r} 
ecodata::plot_condition()
```
]

.pull-right[

*Potential criteria*
.table[
```{r}
tabl <- data.frame("Risk Level" = c("Low", "Low-Moderate", "Moderate-High", "High"),
                   "Definition" = c("Prey availability high (not limiting) and/or good fish condition past 5 years",
                                    "Aggregate prey available for this species has stable or increasing trend, moderate condition",
                                    "Aggregate prey available for this species has significant decreasing trend, poor condition",
                                    "Managed species highly dependent on prey with limited and declining availability, poor condition"))
knitr::kable(tabl, format="html",
             col.names = c("Risk Level", "Definition"),
                           booktabs = T) %>%
  #kable_styling(full_width = TRUE) %>%
  column_spec(1, width = "10em")|>
  column_spec(2, width = "30em")
```
]
]


---
## Food Web (2) - Predation Pressure

This element will be applied at the species level. This element is one of two
separating food web risks to achieving OY for Council managed species
from two sources. This second food web risk element assesses predation
pressure on each species, and the first element assesses prey
availability for each species (see element above).

.pull-left[
*Potential indicators*

*  Predation pressure index

*  Model-derived predation mortality

*  Aggregate predator biomass
]

.pull-right[

*Potential criteria*
.table[
```{r}
tabl <- data.frame("Risk Level" = c("Low", "Low-Moderate", "Moderate-High", "High"),
                   "Definition" = c("Predation pressure represents low proportion of overall mortality",
                                    "Predation pressure moderate proportion of overall mortality, decreasing mortality trend",
                                    "Predation pressure moderate proportion of overall mortality, increasing mortality trend",
                                    "Predation pressure represents high proportion of overall mortality, increasing mortality trend"))
knitr::kable(tabl, format="html",
             col.names = c("Risk Level", "Definition"),
                           booktabs = T) %>%
  #kable_styling(full_width = TRUE) %>%
  column_spec(1, width = "10em")|>
  column_spec(2, width = "30em")
```
]
]

---
## Food Web (3) - Protected Species Prey

This element is applied at the species level.  This element ranks the risks of not achieving protected species
objectives due to species interactions with Council managed species.

.pull-left[

.table[
```{r}
tabl <- data.frame("Risk Level" = c("Low", "Low-Moderate", "Moderate-High", "High"),
                   "Definition" = c("Few interactions with any protected species",
                                    "Important prey of 1-2 protected species, or important
                  prey of 3 or more protected species with management
                  consideration of interaction",
                                    "Important prey of 3 or more protected species",
                                    "Managed species is sole prey for a protected species"))
knitr::kable(tabl, format="html",
             col.names = c("Risk Level", "Definition"),
                           booktabs = T) %>%
  #kable_styling(full_width = TRUE) %>%
  column_spec(1, width = "10em")|>
  column_spec(2, width = "30em")
```
]
]

.pull-right[
```{r}
risk.species<-data.frame(
  Species = c("Ocean Quahog", "Surfclam", "Summer flounder", "Scup", "Black sea bass", "Atl. mackerel", "Chub mackerel", "Butterfish", "Longfin squid", "Shortfin squid", "Golden tilefish", "Blueline tilefish", "Bluefish", "Spiny dogfish", "Monkfish", "Unmanaged forage", "Deepsea corals"),
  # Assess  = c("l", "l", "l",  "l", "l", "l", "h", "l", "lm", "h", "l", "h", "l", "l", "h", "na", "na"),
  # Fstatus = c("l", "l", "h", "l", "l", "l", "lm", "l", "lm", "lm", "l", "h", "l", "h", "lm", "na", "na"),
  # Bstatus = c("l", "l", "lm", "l", "l", "h", "lm", "lm", "lm", "lm", "lm", "mh", "lm", "l", "lm", "na", "na"),
  # #FW1Pred = c("l", "l", "l", "l", "l", "l", "l", "l", "l", "l", "l", "l", "l", "l", "l", "l", "l"),
  # #FW1Prey = c("l", "l", "l", "l", "l", "l", "l", "l", "l", "l", "l", "l", "l", "l", "l", "lm", "l"),
  # PreyA = c("tbd", "tbd", "tbd", "tbd", "tbd", "tbd", "tbd", "tbd", "tbd", "tbd", "tbd", "tbd", "tbd", "tbd", "tbd", "tbd", "tbd"),
  # PredP = c("tbd", "tbd", "tbd", "tbd", "tbd", "tbd", "tbd", "tbd", "tbd", "tbd", "tbd", "tbd", "tbd", "tbd", "tbd", "tbd", "tbd"),
   FW3Prey = c("l", "l", "l", "l", "l", "l", "l", "l", "lm", "lm", "l", "l", "l", "l", "l", "lm", "l")#,
  # Climate = c("h", "mh", "lm", "lm", "mh", "lm", "na", "l", "l", "l", "mh", "mh","l", "l", "l", "na", "na"),
  # DistShift = c("mh", "mh", "mh", "mh", "mh", "mh", "na", "h", "mh", "h", "l", "l", "mh", "h", "mh", "na", "na"),
  # EstHabitat = c("l", "l", "h", "h", "h", "l", "l", "l", "l", "l", "l", "l", "h", "l", "l", "na", "na"),
  # OffHab = c("tbd", "tbd", "tbd", "tbd", "tbd", "tbd", "tbd", "tbd", "tbd", "tbd", "tbd", "tbd", "tbd", "tbd", "tbd", "tbd", "tbd")#,
)


# these elements were removed by the council
#  PopDiv = c("na", "na", "na", "na", "na", "na", "na", "na", "na", "na", "na", "na", "na", "na"),
#  FoodSafe = c(),

# one column test
# risk.species %>%
#   mutate(Fstatus = 
#     cell_spec(Fstatus, format="latex", color = "black", align = "c", background =factor(Fstatus, c("na", "l", "lm", "mh", "h"),c("white", "green", "yellow", "orange", "red")))) %>%
#   kable(risk.species, format="latex", escape = F, booktabs = T, linesep = "")

#convert to longer text for consistency and display in html table
risk.species <- risk.species %>%
     mutate_at(vars(-Species), function(x){
       recode(x,'tbd' = "tbd", 'l'="lowest",'lm'="lowmod",'mh'="modhigh",'h'="highest")}) %>%
     as.data.frame()

#generalize to all
risk.species %>%
  mutate_at(vars(-Species), function(x){ 
    cell_spec(x, format="html", 
              color = factor(x, c("tbd", "na", "lowest", "lowmod", "modhigh", "highest"),c("grey","black", "black", "black", "black", "white")), align = "c", 
              background =factor(x, c("tbd","na", "lowest", "lowmod", "modhigh", "highest"),c("grey","white", "lightgreen", "yellow", "orange", "red")), 
              background_as_tile=F)}) %>%
  kable(format = "html", escape = F, table.attr='class="risktable"') %>%
  kable_styling(font_size = 14) 
#   flextable::flextable()
# 
# # Define colors and ranges
# bg_picker <- scales::col_bin(
#     palette = c("white", "light blue"),
#     domain = c(0, 100), # min and max range can be also set dynamically 
#     bins = c(0, 10, 20)) # as well as the bins
# 
# 
# ftab <- regulartable(SalesData) %>% 
#     bg(j = columns, bg = bg_picker)

```
]

---
## Ecosystem Productivity

This element is applied at the ecosystem level (the Mid-Atlantic
Ecosystem Production Unit).  Productivity at the base of the food web supports and ultimately limits
the amount of managed species production in an ecosystem.

.pull-left[
.table[
```{r , echo=FALSE, message=FALSE, warnings=FALSE, results='asis'}
# tabl <- "
# | Risk Level         | Definition                                                          |  
# |:-------------------|:--------------------------------------------------------------------|
# | Low  | No trend and low variability in revenue |
# | Low-Moderate | Increasing or high variability in revenue |
# | Moderate-High | Significant long term revenue decrease |
# | High | Significant recent decrease in revenue |
# "
# cat(tabl) # output the table in a format good for HTML/PDF/docx conversion

tabl <- data.frame("Risk Level" = c("Low", "Low-Moderate", "Moderate-High", "High"),
                   "Definition" = c("No trends in ecosystem productivity",
                                    "Trend in ecosystem productivity (1-2 measures, increase or decrease)",
                                    "Trend in ecosystem productivity (3+ measures, increase or decrease)",
                                    "Decreasing trend in ecosystem productivity, 4+ measures"))

knitr::kable(tabl, format="html",
             col.names = c("Risk Level", "Definition"),
                           booktabs = T) %>%
  #kable_styling(full_width = TRUE) %>%
  column_spec(1, width = "10em")|>
  column_spec(2, width = "30em")%>%
  row_spec(2, bold = T, background = "yellow")
```
]

Ranked Low-moderate due to increasing zooplankton and decreasing forage trends. Patterns in fish condition and productivity also observed. No trend in primary production.

## Risk Element: <span style="background-color:yellow;">EcoProd</span> 

]

.pull-right[
```{r zoopanom, fig.alt="Changes in zooplankton abundance in the MAB for large (top left) and small (top right) copepods, Cnidarians (bottom left), and Euphausiids (bottom right), with significant increases (orange) in small copeods and Cnidarians.", fig.width=5, fig.asp=1.2}
a <- ecodata::plot_zoo_abundance_anom(report = "MidAtlantic", varName = "copepod") + 
  ggplot2::facet_wrap(~EPU~Var, labeller = labeller(EPU = function(x) {rep("", length(x))}))
b <- ecodata::plot_zoo_abundance_anom(report = "MidAtlantic", varName = "euphausid") + 
  ggplot2::facet_wrap(~EPU~Var, labeller = labeller(EPU = function(x) {rep("", length(x))}))

a/b

```
]

---
## Climate

This element is applied at the species level,
and evaluates risks to species productivity (and therefore to achieving
OY) due to projected climate change factors in the region. 

.pull-left[
.table[
```{r , echo=FALSE, message=FALSE, warnings=FALSE, results='asis'}

tabl <- data.frame("Risk Level" = c("Low", "Low-Moderate", "Moderate-High", "High"),
                   "Definition" = c("No trends in ecosystem productivity",
                                    "Trend in ecosystem productivity (1-2 measures, increase or decrease)",
                                    "Trend in ecosystem productivity (3+ measures, increase or decrease)",
                                    "Decreasing trend in ecosystem productivity, 4+ measures"))

knitr::kable(tabl, format="html",
             col.names = c("Risk Level", "Definition"),
                           booktabs = T) %>%
  #kable_styling(full_width = TRUE) %>%
  column_spec(1, width = "10em")|>
  column_spec(2, width = "30em")
]

.pull-right[

]

---
## Distribution Shifts

---
## Estuarine and Coastal Habitat

---
## Offshore Habitat (new)

---
class: center, center

# Social and Economic Risk Elements

---
class: top, left
## Commercial Value

---
## Marine Recreational Angler Trips

---
## Commercial Fishery Resilience (1) - Revenue Diversity

---
## Commercial Fishery Resilience (2) - Shoreside Support

---
## Commercial Fishery Resilience (3) -- Fleet Diversity

---
## Recreational Fleet Diversity (new)

---
## Fishing Community Vulnerability

---
## Commercial Fishing Production

.pull-left[
Indicator: Commercial landings 

```{r,  fig.asp=0.8}
#code = readLines("https://raw.githubusercontent.com/NOAA-EDAB/ecodata/master/chunk-scripts/human_dimensions_MAB.Rmd-comdat-total-landings.R"),
#total-landings, fig.cap = paste0("Total commercial seafood landings (black) and ",region," managed seafood landings (red).")

ecodata::plot_comdat(report = "MidAtlantic", varName = "landings")
```


]
---
## Recreational/Subsistence Food Production

.pull-right[
Indicators: Recreational harvest
```{r,  fig.asp=.4}
#code = readLines("https://raw.githubusercontent.com/NOAA-EDAB/ecodata/master/chunk-scripts/human_dimensions_MAB.Rmd-recdat-landings.R"),
#, rec-landings, fig.cap = paste0("Total recreational seafood harvest (millions of fish) in the ",region," region.")

ecodata::plot_recdat(report = "MidAtlantic", varName ="landings")

```

---


---
## EAFM Risk Assessment: 2024 Update with new elements

.pull-left[
*Species level risk elements*
```{r sptable}
#tab.cap="Species level risk analysis results; l=low risk (green), lm= low-moderate risk (yellow), mh=moderate to high risk (orange), h=high risk (red)\\label{sptable}",

# spplist     oc,  sc,  flk, scp, bsb, mack, but, lsq, ssq, gtile,  btile,  blu, dog, monk
risk.species<-data.frame(
  Species = c("Ocean Quahog", "Surfclam", "Summer flounder", "Scup", "Black sea bass", "Atl. mackerel", "Chub mackerel", "Butterfish", "Longfin squid", "Shortfin squid", "Golden tilefish", "Blueline tilefish", "Bluefish", "Spiny dogfish", "Monkfish", "Unmanaged forage", "Deepsea corals"),
  Assess  = c("l", "l", "l",  "l", "l", "l", "h", "l", "lm", "h", "l", "h", "l", "l", "h", "na", "na"),
  Fstatus = c("l", "l", "h", "l", "l", "l", "lm", "l", "lm", "lm", "l", "h", "l", "h", "lm", "na", "na"),
  Bstatus = c("l", "l", "lm", "l", "l", "h", "lm", "lm", "lm", "lm", "lm", "mh", "lm", "l", "lm", "na", "na"),
  #FW1Pred = c("l", "l", "l", "l", "l", "l", "l", "l", "l", "l", "l", "l", "l", "l", "l", "l", "l"),
  #FW1Prey = c("l", "l", "l", "l", "l", "l", "l", "l", "l", "l", "l", "l", "l", "l", "l", "lm", "l"),
  PreyA = c("tbd", "tbd", "tbd", "tbd", "tbd", "tbd", "tbd", "tbd", "tbd", "tbd", "tbd", "tbd", "tbd", "tbd", "tbd", "tbd", "tbd"),
  PredP = c("tbd", "tbd", "tbd", "tbd", "tbd", "tbd", "tbd", "tbd", "tbd", "tbd", "tbd", "tbd", "tbd", "tbd", "tbd", "tbd", "tbd"),
  FW2Prey = c("l", "l", "l", "l", "l", "l", "l", "l", "lm", "lm", "l", "l", "l", "l", "l", "lm", "l"),
  Climate = c("h", "mh", "lm", "lm", "mh", "lm", "na", "l", "l", "l", "mh", "mh","l", "l", "l", "na", "na"),
  DistShift = c("mh", "mh", "mh", "mh", "mh", "mh", "na", "h", "mh", "h", "l", "l", "mh", "h", "mh", "na", "na"),
  EstHabitat = c("l", "l", "h", "h", "h", "l", "l", "l", "l", "l", "l", "l", "h", "l", "l", "na", "na"),
  OffHab = c("tbd", "tbd", "tbd", "tbd", "tbd", "tbd", "tbd", "tbd", "tbd", "tbd", "tbd", "tbd", "tbd", "tbd", "tbd", "tbd", "tbd")#,
)


# these elements were removed by the council
#  PopDiv = c("na", "na", "na", "na", "na", "na", "na", "na", "na", "na", "na", "na", "na", "na"),
#  FoodSafe = c(),

# one column test
# risk.species %>%
#   mutate(Fstatus = 
#     cell_spec(Fstatus, format="latex", color = "black", align = "c", background =factor(Fstatus, c("na", "l", "lm", "mh", "h"),c("white", "green", "yellow", "orange", "red")))) %>%
#   kable(risk.species, format="latex", escape = F, booktabs = T, linesep = "")

#convert to longer text for consistency and display in html table
risk.species <- risk.species %>%
     mutate_at(vars(-Species), function(x){
       recode(x,'tbd' = "tbd", 'l'="lowest",'lm'="lowmod",'mh'="modhigh",'h'="highest")}) %>%
     as.data.frame()

#generalize to all
risk.species %>%
  mutate_at(vars(-Species), function(x){ 
    cell_spec(x, format="html", color = factor(x, c("tbd", "na", "lowest", "lowmod", "modhigh", "highest"),c("grey","black", "black", "black", "black", "white")), align = "c", background =factor(x, c("tbd","na", "lowest", "lowmod", "modhigh", "highest"),c("grey","white", "lightgreen", "yellow", "orange", "red")), background_as_tile=F)}) %>%
  kable(format = "html", escape = F, table.attr='class="risktable"') %>%
  kable_styling(font_size = 9) 
```
.contrib[
* Mackerel and dogfish **Fstatus** risk reduced to low, Summer flounder risk increased to high. Spiny dogfish **Bstatus** risk decreased to low
* Indicators in development for new Prey Availability, Predation Pressure, and Offshore Habitat elements
]  

*Ecosystem level risk elements*
```{r ecotable}
#tab.cap="Ecosystem level risk analysis results; l=low risk (green), lm= low-moderate risk (yellow), mh=moderate to high risk (orange), h=high risk (red)\\label{sptable}",

risk.eco<-data.frame(
  System = c("Mid-Atlantic"),
  EcoProd = c("lm"),
  #EcoDiv = c("lm"),
  CommVal = c("mh"),
  RecVal = c("lm"),
  FishRes1 = c("l"),
  FishRes4 = c("mh"),
  #CommJobs = c("mh"),
  #RecJobs = c("l"),
  ComDiv = c("l"),
  RecDiv = c("tbd"),
  Social = c("lm"),
  ComFood = c("h"),
  RecFood = c("mh")
)

#convert to longer text for consistency and display in html table
risk.eco <- risk.eco %>%
     mutate_at(vars(-System), function(x){
       recode(x,'tbd' = "tbd", 'l'="lowest",'lm'="lowmod",'mh'="modhigh",'h'="highest")}) %>%
     as.data.frame()

#make table
risk.eco %>%
  mutate_at(vars(-System), function(x){ 
    cell_spec(x, format="html", color = factor(x, c("tbd", "na", "lowest", "lowmod", "modhigh", "highest"),c("grey","black", "black", "black", "black", "white")), align = "c", background =factor(x, c("tbd","na", "lowest", "lowmod", "modhigh", "highest"),c("grey","white", "lightgreen", "yellow", "orange", "red")), background_as_tile=F)}) %>%
  kable(format = "html", escape = F, table.attr='class="risktable"') %>%
  kable_styling(font_size = 9) 

```
.contrib[
* Recreational value risk increased from low to low-moderate
* Recreational diversity added, risk criteria in development
]  
]  

.pull-right[ 
*Species and Sector level risk elements*
```{r mgttable,  echo=FALSE, message=FALSE, warnings=FALSE}
#tab.cap="Species and sector level risk analysis results; l=low risk (green), lm= low-moderate risk (yellow), mh=moderate to high risk (orange), h=high risk (red)\\label{sptable}",

risk.sppsector<-data.frame(
  Species = c("Ocean Quahog-C", "Surfclam-C", "Summer flounder-R", "Summer flounder-C","Scup-R", "Scup-C","Black sea bass-R", "Black sea bass-C","Atl. mackerel-R", "Atl. mackerel-C","Butterfish-C", "Longfin squid-C", "Shortfin squid-C", "Golden tilefish-R", "Golden tilefish-C","Blueline tilefish-R","Blueline tilefish-C", "Bluefish-R", "Bluefish-C","Spiny dogfish-R", "Spiny dogfish-C", "Chub mackerel-C", "Unmanaged forage", "Deepsea corals"),
  FControl =  c(1,1,2,2,4,1,4,2,2,1,1,1,2,9,1,1,2,2,1,1,1,1,1,9),
  Interact = c(1,1,1,2,1,2,1,2,1,2,2,3,2,1,1,1,1,1,1,1,3,2,1,9),
  #OceanUse =    c(2,2,2,2,2,3,3,4,1,3,3,4,2,1,1,1,1,1,2,1,3,2,3,3),
  OSW1 =    c(6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6),
  OSW2 =    c(6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6),
  OtherUse =    c(6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6),
  RegComplex =  c(1,1,4,2,4,2,4,2,2,4,3,3,3,1,1,2,1,3,2,1,4,1,1,9),
  Discards =    c(3,3,3,3,3,3,3,4,2,2,3,3,1,1,1,1,1,2,2,2,2,1,1,9),
  Allocation =  c(1,1,4,1,4,1,4,1,1,1,1,1,1,1,1,1,1,4,1,1,1,1,1,9) 
)


#convert to text for consistency
risk.sppsector <- risk.sppsector %>%
     mutate_at(vars(-Species), function(x){
       recode(x,'1'="lowest",'2'="lowmod",'3'="modhigh",'4'="highest",'9'="na",
              '6' = 'tbd')}) %>%
     as.data.frame()

#make table
risk.sppsector %>%
  mutate_at(vars(-Species), function(x){ 
    cell_spec(x, format="html", color = factor(x, c("tbd", "na", "lowest", "lowmod", "modhigh", "highest"),c("grey", "black", "black", "black", "black", "white")), align = "c", background =factor(x, c("tbd","na", "lowest", "lowmod", "modhigh", "highest"),c("grey","white", "lightgreen", "yellow", "orange", "red")), background_as_tile=F)}) %>%
  kable(format = "html", escape = F, table.attr='class="risktable"') %>%
  kable_styling(font_size = 10) 

```
.contrib[
* Management fully updated for existing elements 
* Offshore wind (OSW) risks split into 2 new elements in development, non-OSW uses added
]
]


???

---
## Risk Assessment: new indicator previews

Prey Availability Risk

.pull-left[
Evaluate Forage Index for a predator
```{r}
ecodata::plot_forage_index() + ggplot2::coord_cartesian(xlim = c(1983, 2021.5)) + ggplot2::ggtitle("Aggregate forage fish index") 
```

*  Benthic Index in progress for the many Mid-Atlantic benthivores. 
*  Zooplankton Indices needed for planktivores
]

.pull-right[
Along with its Condition index
```{r}
ecodata::plot_condition()
```

And Productivity anomaly (lagged)
]



---
background-image: url("https://github.com/NOAA-EDAB/presentations/raw/master/docs/EDAB_images//noaa-iea.png")
background-size: 350px
background-position: right bottom

## THANK YOU! SOEs made possible by (at least) 80 contributors from 20+ institutions

.table[
![:col_row 
    Kimberly Bastille<br>
    Aaron Beaver (Anchor QEA)<br>
    Andy Beet<br>
    Brandon Beltz<br>
    Ruth Boettcher (Virginia Department of Game and Inland Fisheries)<br>
    Mandy Bromilow (NOAA Chesapeake Bay Office)<br>
    Baoshan Chen (Stony Brook University)<br>
    Zhuomin Chen (U Connecticut)<br>
    Joseph Caracappa<br>
    Doug Christel (GARFO)<br>
    Patricia Clay<br>
    Lisa Colburn<br>
    Jennifer Cudney (NMFS Atlantic HMS Management Division)<br>
    Tobey Curtis (NMFS Atlantic HMS Management Division)<br>
    Art Degaetano (Cornell U)<br>
    Geret DePiper<br>
    Dan Dorfman (NOAA-NOS-NCCOS)<br> 
    Hubert du Pontavice<br>
    Emily Farr (NMFS Office of Habitat Conservation)<br>
    Michael Fogarty<br>
    Paula Fratantoni<br>
    Kevin Friedland<br>
    Marjy Friedrichs (Virginia Institute of Marine Science)<br>
    Sarah Gaichas<br>
    Ben Galuardi (GARFO)<br>
    Avijit Gangopadhyay (School for Marine Science and Technology UMass Dartmouth)<br>
    James Gartland (Virginia Institute of Marine Science)<br>
    Lori Garzio (Rutgers University),
    
    Glen Gawarkiewicz (Woods Hole Oceanographic Institution)<br>
    Sean Hardison<br>
    Dvora Hart<br>
    Kimberly Hyde<br>
    John Kocik<br>
    Steve Kress (National Audubon Society’s Seabird Restoration Program)<br>
    Young-Oh Kwon (Woods Hole Oceanographic Institution)<br>
    Scott Large<br>
    Gabe Larouche (Cornell U)<br>
    Daniel Linden<br>
    Andrew Lipsky<br>
    Sean Lucey<br>
    Don Lyons (National Audubon Society’s Seabird Restoration Program)<br>
    Chris Melrose<br>
    Shannon Meseck<br>
    Ryan Morse<br>
    Ray Mroch (SEFSC)<br>
    Brandon Muffley (MAFMC)<br>
    Kimberly Murray<br>
    David Moe Nelson (NCCOS)<br>
    Janet Nye (University of North Carolina at Chapel Hill)<br>
    Chris Orphanides<br>
    Richard Pace<br>
    Debi Palka<br>
    Tom Parham (Maryland DNR)<br>
    Charles Perretti<br>
    CJ Pellerin (NOAA Chesapeake Bay Office)<br>
    Kristin Precoda,
    
    Grace Roskar (NMFS Office of Habitat Conservation)<br>
    Jeffrey Runge (U Maine)<br>   
    Grace Saba (Rutgers)<br>
    Vincent Saba<br>
    Sarah Salois<br>
    Chris Schillaci (GARFO)<br>
    Amy Schueller (SEFSC)<br>
    Teresa Schwemmer (Stony Brook University)<br>
    Dave Secor (CBL)<br>
    Angela Silva<br>
    Adrienne Silver (UMass/SMAST)<br>
    Emily Slesinger (Rutgers University)<br>
    Laurel Smith<br>
    Talya tenBrink (GARFO)<br>
    Bruce Vogt (NOAA Chesapeake Bay Office)<br>
    Ron Vogel (UMD Cooperative Institute for Satellite Earth System Studies and NOAA/NESDIS Center for Satellite Applications and Research)<br>
    John Walden<br>
    Harvey Walsh<br>
    Changhua Weng<br>
    Dave Wilcox (VIMS)<br>
    Timothy White (Environmental Studies Program BOEM)<br>
    Sarah Wilkin (NMFS Office of Protected Resources)<br>
    Mark Wuenschel<br>
    Qian Zhang (U Maryland)]
]

???


---
## References

.contrib[
```{r refs, echo=FALSE, results="asis"}
PrintBibliography(myBib)
```
]


## Additional resources
.pull-left[
* [ecodata R package](https://github.com/noaa-edab/ecodata)

* [Indicator catalog](https://noaa-edab.github.io/catalog/)

* [SOE Technical Documentation](https://noaa-edab.github.io/tech-doc)

]
.pull-right[
* [SOE Reports on the web](https://www.fisheries.noaa.gov/new-england-mid-atlantic/ecosystems/state-ecosystem-reports-northeast-us-shelf)


.contrib[

* Slides available at https://noaa-edab.github.io/presentations
* Contact: <Sarah.Gaichas@noaa.gov>
]
]

???

